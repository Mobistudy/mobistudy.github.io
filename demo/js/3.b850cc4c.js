(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[3],{"5b54":function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("q-page",{attrs:{padding:""}},[s("q-pull-to-refresh",{attrs:{label:"Default spinner"},on:{refresh:t.refresh}},[t.newstudies?s("q-banner",{staticClass:"bg-warning text-white q-mb-sm",attrs:{rounded:"","inline-actions":"",icon:"new_releases",type:"warning"},scopedSlots:t._u([{key:"action",fn:function(){return[s("q-btn",{attrs:{color:"blue",label:t.$t("studies.checkNewStusy"),to:"studies"}})]},proxy:!0}],null,!1,845094109)},[t._v("\n      "+t._s(t.$t("studies.newStudy"))+"!\n      ")]):t._e(),t.nostudies?s("q-item-label",{staticClass:"q-title fixed-center"},[t._v("\n      "+t._s(t.$t("studies.noStudies"))+"\n    ")]):s("div",{attrs:{highlight:""}},[s("q-item-label",{attrs:{header:""}},[t._v("\n        "+t._s(t.$t("studies.tasks.pendingTasks"))+"\n      ")]),t._l(t.studiesInfo,(function(e){return s("q-list",{key:"upcoming-"+e._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(e.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.upcoming,(function(i,a){return s("taskListItem",{key:"item-"+a,attrs:{task:t.filterTask(i,e),isMissedTask:!1}})}))],2),0===t.tasks.upcoming.length?s("q-item",[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"primary",name:"check"}})],1),s("q-item-section",[s("q-item-label",[t._v(t._s(t.$t("studies.tasks.noPendingTasks")))])],1)],1):t._e()],1)})),s("q-item-label",{attrs:{header:""}},[t._v("\n        "+t._s(t.$t("studies.tasks.missedTasks"))+"\n      ")]),t._l(t.studiesInfo,(function(e){return s("q-list",{key:"missed-"+e._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[t.tasks.missed.length>0?s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(e.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.missed,(function(i,a){return s("taskListItem",{key:"item-"+e._key+"-"+a,attrs:{task:t.filterTask(i,e),isMissedTask:!0}})}))],2):s("q-item",[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"primary",name:"check"}})],1),s("q-item-section",[s("q-item-label",[t._v(t._s(t.$t("studies.tasks.noMissedTasks")))])],1)],1)],1)})),t.tasks.alwaysOn.length>0?s("div",[s("q-item-label",{attrs:{header:""}},[t._v("\n          "+t._s(t.$t("studies.tasks.alwaysOnTasks"))+"\n        ")]),t._l(t.studiesInfo,(function(e){return s("q-list",{key:"alwayson-"+e._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(e.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.alwaysOn,(function(i,a){return s("taskListItem",{key:"item-"+a,attrs:{task:t.filterTask(i,e),isMissedTask:!1}})}))],2)],1)}))],2):t._e()],2)],1),this.tasks.completedStudyAlert?s("q-dialog",{attrs:{maximized:""},model:{value:t.completedStudyModal,callback:function(e){t.completedStudyModal=e},expression:"completedStudyModal"}},[s("div",{staticClass:"q-pa-lg text-center",staticStyle:{"background-color":"white"}},[s("div",{staticClass:"text-h4 q-mb-md"},[t._v(t._s(t.$t("studies.studyCompletedHeadline"))+"!")]),s("div",[s("img",{staticStyle:{width:"30vw","max-width":"150px"},attrs:{src:"imgs/confetti.svg"}})]),s("p",{domProps:{innerHTML:t._s(t.$t("studies.studyCompletedText",{studyname:t.completedStudyTitle}))}}),s("q-btn",{attrs:{color:"primary",label:t.$t("common.close")},on:{click:function(e){return t.studyCompleted()}}})],1)]):t._e()],1)},a=[],n=(s("e6cf"),s("ddb0"),function(){var t=this,e=t.$createElement,s=t._self._c||e;return this.task.studyKey?s("q-item",{nativeOn:{click:function(e){return t.changeRoute(e)}}},[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"grey",name:t.icon}})],1),s("q-item-section",[s("q-item-label",[t._v(t._s(t.title))]),s("q-item-label",{attrs:{caption:""}},[t._v(t._s(t.main))])],1),this.isMissedTask?s("q-item-section",{attrs:{side:"",top:""}},[t._v("\n    "+t._s(t.timeRemaining)+"\n  ")]):t._e()],1):t._e()}),r=[],o=s("c1df"),d=s.n(o),l={name:"TaskListItem",props:["task","isMissedTask"],data(){return{icon:void 0,title:void 0,main:void 0}},methods:{changeRoute:function(){const t=this.task.type,e=this.task.studyKey,s=this.task.taskId,i=this.task.formKey;if("form"===t)this.$router.push({name:"formIntro",params:{studyKey:e,taskId:s,formKey:i},query:{icon:this.icon,title:this.title}});else if("smwt"===t)this.$router.push({name:"smwtIntro",params:{studyKey:e,taskId:s},query:{icon:this.icon,title:this.title}});else if("qcst"===t)this.$router.push({name:"qcstIntro",params:{studyKey:e,taskId:s},query:{icon:this.icon,title:this.title}});else if("miband3"===t)this.$router.push({name:"miband3Intro",params:{studyKey:e,taskId:s},query:{icon:this.icon,title:this.title}});else if("po60"===t)this.$router.push({name:"po60Intro",params:{studyKey:e,taskId:s},query:{icon:this.icon,title:this.title}});else{if("dataQuery"!==t)throw new Error("Could not changeRoute with task type.");this.$router.push({name:"dataQueryIntro",params:{taskId:s,studyKey:e},query:{icon:this.icon,title:this.title}})}}},created(){"dataQuery"===this.task.type?(this.title=this.$i18n.t("studies.tasks.dataQuery.shortTitle"),this.main=this.$i18n.t("studies.tasks.dataQuery.shortDescription"),this.icon="insert_chart_outlined"):"form"===this.task.type?(this.title=this.task.formName[this.$root.$i18n.locale],this.main=this.$i18n.t("studies.tasks.form.shortDescription"),this.icon="format_list_bulleted"):"smwt"===this.task.type?(this.title=this.$i18n.t("studies.tasks.smwt.shortTitle"),this.main=this.$i18n.t("studies.tasks.smwt.shortDescription"),this.icon="directions_walk"):"qcst"===this.task.type?(this.title=this.$i18n.t("studies.tasks.qcst.shortTitle"),this.main=this.$i18n.t("studies.tasks.qcst.shortDescription"),this.icon="layers"):"miband3"===this.task.type?(this.title=this.$i18n.t("studies.tasks.miband3.shortTitle"),this.main=this.$i18n.t("studies.tasks.miband3.shortDescription"),this.icon="watch"):"po60"===this.task.type&&(this.title=this.$i18n.t("studies.tasks.po60.shortTitle"),this.main=this.$i18n.t("studies.tasks.po60.shortDescription"),this.icon="touch_app")},computed:{timeRemaining:function(){return"Due "+d()(this.task.due).fromNow()}}},c=l,u=s("2877"),h=s("66e5"),m=s("4074"),y=s("0016"),p=s("0170"),f=s("eebe"),k=s.n(f),w=Object(u["a"])(c,n,r,!1,null,null,null),g=w.exports;k()(w,"components",{QItem:h["a"],QItemSection:m["a"],QIcon:y["a"],QItemLabel:p["a"]});var b=s("9bf1"),_=s("6a6d"),q=s("c313"),S=(s("c975"),s("fb6a"),s("8847")),v=s("55b4"),$=s("3615"),D=s("0967"),I=s("1e59");function T(t,e){let s={upcoming:[],missed:[],alwaysOn:[]};for(const i of t)if("accepted"===i.currentStatus){let t=e.find((t=>t._key===i.studyKey));if((new Date).toISOString()>t.generalities.endDate+"T23:59:59"){s.completedStudyAlert={studyTitle:t.generalities.title,studyPart:i};continue}const a=t.tasks.filter((t=>{const e=i.taskItemsConsent.find((e=>e.taskId===t.id));return e.consented}));let n=!0;for(const e of a)if(e.scheduling.alwaysOn){if(O(i.acceptedTS,e.scheduling)){n=!1;let i={type:e.type,studyKey:t._key,taskId:e.id,alwaysOn:!0};"form"===e.type&&(i.formName=e.formName,i.formKey=e.formKey),s.alwaysOn.push(i)}}else{let a,r,d,l=o(new Date(t.generalities.endDate)).add(1,"days").toDate(),c=K(i.acceptedTS,l,e.scheduling),u=c.between(o().startOf("day").toDate(),o(l).endOf("day").toDate());if(u.length>0&&(n=!1),"dataQuery"===e.type){if(D["b"].is.ios&&I["a"].isAndroidOnly(e.dataType))continue;if(D["b"].is.android&&I["a"].isIOSOnly(e.dataType))continue}if(i.taskItemsConsent){const t=i.taskItemsConsent.find((t=>t.taskId===e.id));t&&t.lastExecuted&&(r=o(new Date(t.lastExecuted)))}r?(a=c.between(r.toDate(),o().startOf("day").toDate()),a=a.length>0?a[a.length-1]:null):a=c.before(o().startOf("day").toDate()),r&&r.isAfter(o().startOf("day"))?d=null:(d=c.between(o().startOf("day").toDate(),o().endOf("day").toDate()),d=d.length>0?d[0]:null);let h={type:e.type,studyKey:t._key,taskId:e.id};"form"===e.type&&(h.formName=e.formName,h.formKey=e.formKey),null!==d?s.upcoming.push(Object.assign({missed:!1,due:d},h)):null!==a&&s.missed.push(Object.assign({missed:!0,due:a},h))}n&&(s.completedStudyAlert={studyTitle:t.generalities.title,studyPart:i})}return s}function O(t,e){if(!t||!e)throw new Error("both arguments must be specified in isAlwaysOnTaskDue");let s=new Date,i=new Date(t);if("consent"!==e.startEvent)throw new Error("The only start event recognised is consent");if(e.startDelaySecs&&(i=new Date(i.getTime()+1e3*e.startDelaySecs)),e.untilSecs){let t=new Date(i.getTime()+1e3*e.untilSecs);if(s>i&&s<t)return!0}else if(s>i)return!0;return!1}function K(t,e,s){let i=o(t);if("consent"!==s.startEvent)throw new Error("The only start event recognised is consent");s.startDelaySecs&&(i=i.clone().add(s.startDelaySecs,"s"));let a,n=o(e);if(s.untilSecs){let t=i.clone().add(s.untilSecs,"s");t.isBefore(n)&&(n=t.clone())}switch(s.intervalType){case"y":a=v["a"].YEARLY;break;case"m":a=v["a"].MONTHLY;break;case"w":a=v["a"].WEEKLY;break;case"d":a=v["a"].DAILY;break;default:throw new Error("No Frequency Specified")}let r=[];if(s.weekDays)for(let o=0;o<s.weekDays.length;o++)switch(s.weekDays[o]){case"mo":r.push(v["a"].MO);break;case"tu":r.push(v["a"].TU);break;case"we":r.push(v["a"].WE);break;case"th":r.push(v["a"].TH);break;case"fr":r.push(v["a"].FR);break;case"sa":r.push(v["a"].SA);break;case"su":r.push(v["a"].SU);break}let d={};d.dtstart=i.toDate(),d.until=n.toDate(),d.freq=a,s.interval&&(d.interval=s.interval),s.months&&(d.bymonth=s.months),s.monthDays&&(d.bymonthday=s.monthDays),d.byweekday=r,s.occurrences&&(d.count=s.occurrences);try{return new v["a"](d)}catch(l){throw console.error("Error while parsing scheduling object",d),console.error("Scheduling information: ",s),console.error("Star time, study end:",t,e),l}}async function C(){return $["a"].cancelAll()}async function x(t,e,s){let i=[],a=[];for(const n of e.tasks){if("dataQuery"===n.type){if(D["b"].is.ios&&I["a"].isAndroidOnly(n.dataType))continue;if(D["b"].is.android&&I["a"].isIOSOnly(n.dataType))continue}if(n.scheduling.alwaysOn)continue;let r=K(t,new Date(e.generalities.endDate),n.scheduling),d=r.between(new Date,new Date(e.generalities.endDate),!0);for(let t=0;t<d.length&&t<1e3;t++){let r,l=d[t],c=o(l).startOf("minute").toDate(),u="";if(e._key){let t=e._key.toString();u+=t.slice(-4)}if(u+=n.id,u+=t,s.taskItemsConsent){const t=s.taskItemsConsent.find((t=>t.taskId===n.id));t&&t.lastExecuted&&(r=o(new Date(t.lastExecuted)))}let h=!1;r&&o(c).isBetween(o().startOf("day"),o().endOf("day"))&&r.isBetween(o().startOf("day"),o(c))&&(h=!0),-1!==a.indexOf(o(c).unix())||h||(a.push(o(c).unix()),i.push({id:parseInt(u),title:S["b"].t("studies.scheduling.due"),text:S["b"].t("studies.scheduling.start"),foreground:!0,trigger:{at:c}}))}}await $["a"].schedule(i)}var Q={name:"TaskerPage",components:{taskListItem:g},data(){return{nostudies:!1,newstudies:!1,tasks:{upcoming:[],missed:[],alwaysOn:[],completedStudyAlert:void 0,completedStudyTitle:void 0},completedStudyModal:!1,studiesInfo:[]}},async created(){this.load()},methods:{refresh(t){this.load(!0).then(t)},filterTask(t,e){return t.studyKey===e._key?t:""},async load(t){t||this.$q.loading.show();try{try{let t=await q["a"].getNewStudiesKeys();t.length>0?this.newstudies=!0:this.newstudies=!1}catch(e){console.error("Cannot connect to server, but thats OK",e)}await C();try{let t=await q["a"].getProfile(b["a"].user._key);if(!t.studies||0===t.studies.length)return await _["a"].setStudiesParticipation([]),this.$q.loading.hide(),void(this.nostudies=!0);await _["a"].setStudiesParticipation(t.studies)}catch(e){console.error("Cannot connect to server, but thats OK",e)}let t=await _["a"].getStudiesParticipation();if(!t)return this.$q.loading.hide(),void(this.nostudies=!0);let s=[],i=[];this.studiesInfo=[];for(const e of t){let t=await _["a"].getStudyDescription(e.studyKey);t||(t=await q["a"].getStudyDescription(e.studyKey),await _["a"].setStudyDescription(e.studyKey,t)),"accepted"===e.currentStatus&&e.reminders&&await x(new Date(e.acceptedTS),t,e),"accepted"===e.currentStatus&&(s.push(e),i.push(t),this.studiesInfo.push(t))}if(0===i.length)return this.$q.loading.hide(),void(this.nostudies=!0);let a=T(s,i);this.tasks=a,a.completedStudyAlert&&(this.completedStudyTitle=a.completedStudyAlert.studyTitle[this.$root.$i18n.locale],this.completedStudyModal=!0),this.$q.loading.hide()}catch(e){console.error(e),this.$q.loading.hide(),this.$q.dialog({title:this.$i18n.t("errors.error"),message:this.$i18n.t("errors.generalError"),color:"warning",ok:this.$i18n.t("common.retry"),preventClose:!0}).onOk((()=>{this.load()}))}},async studyCompleted(){let t=this.tasks.completedStudyAlert.studyPart;t.currentStatus="completed",t.completedTS=new Date;try{await q["a"].updateStudyStatus(b["a"].user._key,t.studyKey,t),delete t.extraItemsConsent,delete t.taskItemsConsent,await _["a"].setStudyParticipation(t),this.load(),this.completedStudyModal=!1}catch(e){console.error("Cannot set the study as completed",e),this.$q.notify({color:"negative",message:this.$i18n.t("errors.connectionError")+": "+e.message,icon:"report_problem"})}}}},E=Q,A=s("9989"),M=s("59d7"),L=s("54e1"),P=s("9c40"),N=s("1c1c"),R=s("24e8"),j=Object(u["a"])(E,i,a,!1,null,null,null);e["default"]=j.exports;k()(j,"components",{QPage:A["a"],QPullToRefresh:M["a"],QBanner:L["a"],QBtn:P["a"],QItemLabel:p["a"],QList:N["a"],QItemSection:m["a"],QItem:h["a"],QIcon:y["a"],QDialog:R["a"]})}}]);