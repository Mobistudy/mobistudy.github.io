(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[9],{"41c7":function(t,s,i){},"722d":function(t,s,i){"use strict";i("41c7")},"9d0e":function(t,s,i){"use strict";i.r(s);var e=function(){var t=this,s=t._self._c;return s("q-page",{attrs:{padding:""}},[s("div",{staticClass:"text-center text-h5 q-mt-lg"},[t._v("\n    "+t._s(t.$t("studies.tasks.smwt.title"))+"\n  ")]),s("div",{ref:"map",staticClass:"row justify-center items-center",staticStyle:{width:"100%",height:"50vh"}},[s("WalkingMan")],1),s("div",{directives:[{name:"show",rawName:"v-show",value:t.isSignalCheck,expression:"isSignalCheck"}],staticClass:"text-subtitle1 text-center"},[t._v(t._s(t.$t("studies.tasks.smwt.signalCheck")))]),s("p",{directives:[{name:"show",rawName:"v-show",value:!t.isSignalCheck,expression:"!isSignalCheck"}],attrs:{id:"timer"}},[t._v(" "+t._s(t.minutes)+":"+t._s(t.seconds)+" ")]),s("div",{staticClass:"row justify-center q-mt-lg"},[s("q-btn",{directives:[{name:"show",rawName:"v-show",value:!t.isStarted,expression:"!isStarted"}],staticClass:"full-width mobibtn",attrs:{color:"primary",label:t.$t("common.start"),disabled:t.isSignalCheck},on:{click:t.startTest}}),s("q-btn",{directives:[{name:"show",rawName:"v-show",value:t.isStarted,expression:"isStarted"}],staticClass:"full-width mobibtn",attrs:{color:"negative",label:t.$t("common.complete")},on:{click:t.completeTest}})],1)])},o=[],n=(i("14d9"),i("a5f6")),a=(i("3c65"),{MAX_SPEED:2,CHECKSIGNAL_MINACCURACY:15,SELECTION_PERIOD:5,positions:[],selectedPositions:[],distance:0,showdistance:0,started:!1,startTest:function(t){this.distance=0,this.started=!0,this.selectedPositions=[];let s=this.selectPosition(this.positions[0].timestamp,this.SELECTION_PERIOD/4);s||(s=this.positions[0]),this.selectedPositions.unshift(s)},stopTest:function(){if(this.started=!1,void 0===this.positions[0].steps||0!==this.positions[0].steps){var t=this.selectPosition(this.positions[0].timestamp,10);t||(t=this.positions[0]),t.timestamp!==this.selectedPositions[0].timestamp&&(this.distance+=this.crowDist(this.selectedPositions[0],t),this.selectedPositions.unshift(t))}else this.distance=0},reset:function(){this.distance=0,this.showdistance=0,this.started=!1,this.positions=[],this.selectedPositions=[]},addPosition:function(t){if(this.positions.unshift(t),this.started&&t.timestamp-this.selectedPositions[0].timestamp>=1e3*this.SELECTION_PERIOD){let s=this.selectPosition(t.timestamp,this.SELECTION_PERIOD/4);if(s)return this.distance+=this.crowDist(this.selectedPositions[0],s),this.selectedPositions.unshift(s),!0}return!1},isSignalOK:function(){if(0===this.positions.length)return!1;let t=this.positions[0];return t&&t.coords.altitude&&t.coords.accuracy<=this.CHECKSIGNAL_MINACCURACY},getDistance:function(){if(this.started){if(this.positions.length>1&&(this.positions[0].steps||0===this.positions[0].steps)&&this.positions[0].steps-this.positions[1].steps===0)return this.showdistance;let t=this.crowDist(this.selectedPositions[0],this.positions[0]);return this.showdistance=this.distance+t,this.showdistance}return this.distance},crowDist:function(t,s){let i=t.coords.latitude,e=s.coords.latitude,o=t.coords.longitude,n=s.coords.longitude,a=6371,r=this.toRad(e-i),c=this.toRad(n-o);i=this.toRad(i),e=this.toRad(e);let h=Math.sin(r/2)*Math.sin(r/2)+Math.sin(c/2)*Math.sin(c/2)*Math.cos(i)*Math.cos(e),l=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),p=a*l;return 1e3*p},toRad:function(t){return t*Math.PI/180},selectPosition:function(t,s){if(this.positions.length>1&&this.positions[0].steps&&this.positions[0].steps-this.positions[1].steps===0)return null;let i=1e4,e=-1;for(let o=0;o<this.positions.length;o++){let n=this.positions[o];if(t-n.timestamp>1e3*s)return e>=0?this.positions[e]:null;if(n.coords.accuracy<5)return n;let a=0;this.selectedPositions.length>0&&(a=this.crowDist(n,this.selectedPositions[0])/((t-this.selectedPositions[0].timestamp)/1e3)),a<this.MAX_SPEED&&n.coords.accuracy<i&&(i=this.positions[o].coords.accuracy,e=o)}return this.positions[e]}}),r=i("9bf1"),c=i("7937"),h=i("ea6a");const l=360,p=6e4;let d=[],m=[];var u={name:"SMWTPage",props:{studyKey:String,taskId:Number},components:{WalkingMan:h["a"]},data:function(){return{isSignalCheck:!0,isStarted:!1,isCompleted:!1,timer:void 0,totalTime:l,startedTS:void 0,completionTS:void 0,positions:[],steps:[],distance:0}},mounted:async function(){a.reset(),this.isSignalCheck=!0;let t=new Date;try{await n["a"].geolocation.isAvailable()?(console.log("GPS is available"),n["a"].geolocation.startNotifications({maximumAge:5e3,timeout:5e3,enableHighAccuracy:!0},(async s=>{console.log("Got position: ",s),0===this.positions.length&&setTimeout((function(){this.isSignalCheck=!1}),p),this.positions.push(s),0!==this.steps.length&&(s.steps=this.steps[this.steps.length-1].steps),a.addPosition(s),this.isSignalCheck&&(a.isSignalOK()||new Date-t>=p)&&(this.isSignalCheck=!1)}),(t=>{console.error("Cannot retrieve GPS position",t)}))):console.error("No GPS available")}catch(s){console.error("Issues while starting the GPS",s)}},methods:{async startTest(){this.isStarted=!0,this.startedTS=new Date,this.startTimer(),n["a"].screen.forbidSleep(),a.startTest(),d=[],m=[];try{await n["a"].orientation.isAvailable()&&(await n["a"].orientation.requestPermission(),n["a"].orientation.startNotifications({},(t=>{d.push(t)}),(t=>{console.error("Error getting orientation event",t)})))}catch(t){console.error("Error getting orientation event",t)}try{await n["a"].motion.isAvailable()&&(await n["a"].motion.requestPermission(),n["a"].motion.startNotifications({},(t=>{m.push(t)}),(t=>{console.error("Error getting MotionEvent",t)})))}catch(t){console.error("Error getting motion event",t)}try{await n["a"].pedometer.isAvailable()&&n["a"].pedometer.startNotifications({},(t=>{this.steps.push(t)}),(t=>{console.error("Error getting steps",t)}))}catch(t){console.error("Cannot instantiate pedometer",t)}},startTimer(){this.totalTime=l,this.timer=setInterval((()=>this.countDown()),1e3),h["a"].methods.play()},stopTimer(){clearInterval(this.timer),h["a"].methods.stop()},countDown(){this.totalTime>=1?this.totalTime--:this.completeTest()},completeTest(){this.isStarted=!1,this.completionTS=new Date,this.stopTimer(),n["a"].orientation.stopNotifications(),n["a"].motion.stopNotifications(),n["a"].pedometer.stopNotifications(),n["a"].geolocation.stopNotifications(),n["a"].screen.allowSleep(),this.isCompleted=!0,a.stopTest(),this.distance=a.getDistance();let t={userKey:r["a"].user._key,participantKey:r["a"].user.participantKey,studyKey:this.studyKey,taskId:parseInt(this.taskId),taskType:"smwt",createdTS:new Date,phone:n["a"].device,summary:{startedTS:this.startedTS,completedTS:this.completionTS,distance:this.distance,steps:this.steps[this.steps.length-1].numberOfSteps,borgScale:void 0},data:{positions:this.positions,steps:this.steps,inertial:{motion:m,orientation:d}}};this.$router.push({name:"smwtSummary",params:{report:t}})}},computed:{minutes(){return c["c"].pad(Math.floor(this.totalTime/60))},seconds(){return c["c"].pad(this.totalTime-60*this.minutes)}},beforeDestroy:function(){this.stopTimer(),n["a"].orientation.stopNotifications(),n["a"].motion.stopNotifications(),n["a"].pedometer.stopNotifications(),n["a"].screen.allowSleep(),n["a"].geolocation.stopNotifications()}},g=u,f=(i("722d"),i("2877")),w=i("9989"),S=i("9c40"),v=i("eebe"),T=i.n(v),C=Object(f["a"])(g,e,o,!1,null,"d06d6200",null);s["default"]=C.exports;T()(C,"components",{QPage:w["a"],QBtn:S["a"]})}}]);