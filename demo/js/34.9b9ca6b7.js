(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[34],{b224:function(t,e,a){"use strict";a.r(e);var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-page",{attrs:{id:"main"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:!t.isDownloading,expression:"!isDownloading"}]},[a("p",{staticClass:"q-pa-md"},[t._v(t._s(t.$t("studies.tasks.miband3.chartsIntro")))]),a("div",{staticClass:"text-center text-h6"},[t._v("\n      "+t._s(t.$t("studies.tasks.miband3.lineChart"))+"\n    ")]),a("div",{staticClass:"q-pa-md"},[a("canvas",{ref:"lineChart",attrs:{height:"270"}}),a("div",{staticClass:"row justify-around"},[a("q-btn",{attrs:{label:"-12 "+t.$t("studies.tasks.miband3.hours"),color:"secondary",disable:t.disableMinus},on:{click:function(e){t.lineChartAdd(-12)}}}),a("q-btn",{attrs:{label:"+12 "+t.$t("studies.tasks.miband3.hours"),color:"secondary",disable:t.disablePlus},on:{click:function(e){t.lineChartAdd(12)}}})],1)]),a("q-separator"),a("div",{staticClass:"text-center text-h6"},[t._v("\n      "+t._s(t.$t("studies.tasks.miband3.pieChart"))+"\n    ")]),a("div",{staticClass:"q-pa-md"},[a("canvas",{ref:"pieChart",attrs:{height:"270"}})]),a("q-separator"),a("div",{staticClass:"q-my-md row justify-around"},[a("q-btn",{attrs:{label:t.$t("common.skip"),flat:"",color:"negative"},on:{click:function(e){return t.skipSend()}}}),a("q-btn",{attrs:{label:t.$t("common.send"),color:"primary"},on:{click:function(e){return t.sendData()}}})],1)],1),a("q-inner-loading",{attrs:{showing:t.isDownloading}},[a("div",{staticClass:"text-overline"},[t._v(t._s(t.$t("studies.tasks.miband3.dataDownload")))]),a("q-spinner-oval",{attrs:{size:"50px",color:"primary"}})],1)],1)},r=[],s=(a("ac6a"),a("ac4d"),a("8a81"),a("5df3"),a("1c4c"),a("7f7f"),a("6b54"),a("06db"),a("967e")),i=a.n(s),o=(a("96cf"),a("fa84")),c=a.n(o),u=(a("c5f6"),a("e995")),d=a("30ef"),l=a.n(d);function h(t){switch(t){case 1:return"walk";case 6:return"charging";case 17:return"activity_high";case 112:case 122:return"sleep";default:return"unknown"}}var p=a("6a6d"),f=a("9bf1"),b=a("aa9c"),v=a("c1df"),m=a.n(v);function w(t,e){var a;if("undefined"===typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(a=y(t))||e&&t&&"number"===typeof t.length){a&&(t=a);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,o=!1;return{s:function(){a=t[Symbol.iterator]()},n:function(){var t=a.next();return i=t.done,t},e:function(t){o=!0,s=t},f:function(){try{i||null==a.return||a.return()}finally{if(o)throw s}}}}function y(t,e){if(t){if("string"===typeof t)return k(t,e);var a=Object.prototype.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?k(t,e):void 0}}function k(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=new Array(e);a<e;a++)n[a]=t[a];return n}var x=["#800000","#778000","#118000","#008080","#003780","#080080","#440080","#790080","#800046","#800046"],g=[],C=30,D={type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},options:{animation:{animateScale:!0}},indexes:[],maxIndex:-1,reset:function(){this.data.datasets.data=[],this.data.datasets.backgroundColor=[],this.data.labels=[],this.indexes=[],this.maxIndex=-1}},$={hrs:[],steps:[],intensities:[],labels:[],reset:function(){this.hrs=[],this.steps=[],this.intensities=[],this.labels=[]}},S={props:{studyKey:String,taskId:Number},data:function(){return{startDate:new Date,deviceInfo:{},isDownloading:!1,lineChart:void 0,currentStartHour:0,currentEndHour:12,disableMinus:!0,disablePlus:!1}},methods:{downloadData:function(){var t=this;return c()(i.a.mark((function e(){return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.isDownloading=!0,g=[],D.reset(),$.reset(),e.next=6,t.getDateUsedToDownload();case 6:return t.startDate=e.sent,e.prev=7,e.next=10,u["a"].getStoredData(t.startDate,t.dataCallback);case 10:if(!(g.length<C)){e.next=15;break}return e.next=13,t.storeDownloadTimestamp();case 13:return t.$router.push({name:"notEnoughDataPage"}),e.abrupt("return");case 15:return e.next=17,u["a"].getDeviceInfo();case 17:return t.deviceInfo=e.sent,e.prev=18,e.next=21,u["a"].disconnect();case 21:e.next=26;break;case 23:e.prev=23,e.t0=e["catch"](18),console.error("cannot disconnect miband3",e.t0);case 26:t.createPieChart(),t.renderLineChart(t.currentStartHour,t.currentEndHour),t.isDownloading=!1,e.next=35;break;case 31:e.prev=31,e.t1=e["catch"](7),console.error("cannot download data",e.t1),t.showErrorDialog();case 35:case"end":return e.stop()}}),e,null,[[7,31],[18,23]])})))()},storeDownloadTimestamp:function(){var t=this;return c()(i.a.mark((function e(){var a,n;return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return a=g.length>C?g[g.length-1].date:t.startDate,e.next=3,p["a"].getDeviceMiBand3();case 3:return n=e.sent,n.lastStoredDataDate=a,e.abrupt("return",p["a"].setDeviceMiBand3(n));case 6:case"end":return e.stop()}}),e)})))()},getDateUsedToDownload:function(){var t=this;return c()(i.a.mark((function e(){var a,n,r,s,o,c;return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,p["a"].getDeviceMiBand3();case 2:if(n=e.sent,!n.lastStoredDataDate){e.next=7;break}a=new Date(n.lastStoredDataDate),e.next=12;break;case 7:return e.next=9,p["a"].getTaskDescription(t.studyKey,t.taskId);case 9:r=e.sent,s=r.lastExecuted,s?a=new Date(s):(a=m()(),o=r.scheduling.intervalType,c=r.scheduling.interval,"d"===o?a.subtract(c,"days"):"w"===o?a.subtract(c,"weeks"):"m"===o?a.subtract(c,"months"):"y"===o&&a.subtract(c,"years"),a=a.toDate());case 12:return console.log("Start date:",a),e.abrupt("return",a);case 14:case"end":return e.stop()}}),e)})))()},renderLineChart:function(t,e){$.reset();var a=60*t,n=60*e-1;n>g.length&&(n=g.length-1);for(var r=a;r<=n;r++){var s=g[r];this.addToLineChart(s.hr,s.intensity,s.steps,s.date)}this.updateLineChartReferences(),this.updatePlusMinusButtons()},showErrorDialog:function(){var t=this;this.$q.dialog({title:this.$t("errors.error"),message:this.$t("studies.tasks.miband3.dataDownloadError"),cancel:this.$t("common.cancel"),ok:this.$t("common.retry"),persistent:!0}).onOk((function(){t.downloadData()})).onCancel((function(){t.cancelTask()}))},cancelTask:function(){var t=this;return c()(i.a.mark((function e(){return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u["a"].disconnect();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.error("cannot disconnect miband3",e.t0);case 8:t.$router.push({name:"tasker"});case 9:case"end":return e.stop()}}),e,null,[[0,5]])})))()},dataCallback:function(t){g.push(t)},addToLineChart:function(t,e,a,n){t>30&&t<210&&$.hrs.push({x:n,y:t}),$.intensities.push({x:n,y:e}),$.steps.push({x:n,y:a}),$.labels.push(n)},createPieChart:function(){var t,e=w(g);try{for(e.s();!(t=e.n()).done;){var a=t.value,n=a.activityType,r=h(n);if(void 0===D.indexes[r]){D.maxIndex++;var s=D.maxIndex;D.indexes[r]=s,D.data.datasets[0].data[s]=1,D.data.datasets[0].backgroundColor[s]=x[s],D.data.labels.push(this.$t("studies.tasks.miband3.activityTypes."+r))}else{var i=D.indexes[r];D.data.datasets[0].data[i]++}}}catch(c){e.e(c)}finally{e.f()}var o=this.$refs.pieChart;new l.a(o,D)},updateLineChartReferences:function(){this.lineChart.data.datasets[0].data=$.hrs,this.lineChart.data.datasets[1].data=$.intensities,this.lineChart.data.datasets[2].data=$.steps,this.lineChart.data.labels=$.labels,this.lineChart.update()},createActivityLineChart:function(){var t=this.$refs.lineChart;this.lineChart=new l.a.Scatter(t,{type:"scatter",data:{labels:$.labels,datasets:[{label:this.$t("studies.tasks.miband3.hrs"),data:$.hrs,backgroundColor:"#C74038",borderColor:"#C74038",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.intensities"),data:$.intensities,backgroundColor:"#4038C7",borderColor:"#4038C7",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.steps"),data:$.steps,backgroundColor:"#38C740",borderColor:"#38C740",borderWidth:0,pointRadius:1,fill:!1,lineTension:0}]},options:{responsive:!0,title:{display:!1},scales:{xAxes:[{type:"time",time:{displayFormats:{quarter:"HH:MM:SS"}},scaleLabel:{display:!0,lineChartLabelstring:"Date"}}],yAxes:[{scaleLabel:{display:!0,lineChartLabelstring:"value"}}]}}}),this.lineChart.update()},lineChartAdd:function(t){this.currentStartHour+=t,this.currentEndHour+=t,this.renderLineChart(this.currentStartHour,this.currentEndHour),this.updatePlusMinusButtons()},updatePlusMinusButtons:function(){0===this.currentStartHour?this.disableMinus=!0:this.disableMinus=!1,this.currentEndHour>=g.length/60?this.disablePlus=!0:this.disablePlus=!1},skipSend:function(){var t=this;return c()(i.a.mark((function e(){var a,n;return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.storeDownloadTimestamp();case 2:return a=t.studyKey,n=Number(t.taskId),e.next=6,p["a"].setTaskCompletion(a,n,new Date);case 6:t.$router.push("/home");case 7:case"end":return e.stop()}}),e)})))()},sendData:function(){var t=this;return c()(i.a.mark((function e(){var a,n;return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,a=t.studyKey,n=Number(t.taskId),e.next=5,b["a"].sendMiBand3Data({userKey:f["a"].user._key,studyKey:a,taskId:n,createdTS:new Date,device:t.deviceInfo,miband3Data:g});case 5:return e.next=7,t.storeDownloadTimestamp(t.startDate);case 7:return e.next=9,p["a"].setTaskCompletion(a,n,new Date);case 9:t.$router.push("/home"),e.next=17;break;case 12:e.prev=12,e.t0=e["catch"](0),t.loading=!1,console.error(e.t0),t.$q.notify({color:"negative",message:t.$t("errors.connectionError")+" "+e.t0.message,icon:"report_problem",onDismiss:function(){this.$router.push("/home")}});case 17:case"end":return e.stop()}}),e,null,[[0,12]])})))()}},mounted:function(){var t=this;return c()(i.a.mark((function e(){return i.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.createActivityLineChart(),e.next=3,t.downloadData();case 3:case"end":return e.stop()}}),e)})))()},beforeDestroy:function(){return c()(i.a.mark((function t(){return i.a.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,u["a"].disconnect();case 3:t.next=8;break;case 5:t.prev=5,t.t0=t["catch"](0),console.error("cannot disconnect miband3",t.t0);case 8:case"end":return t.stop()}}),t,null,[[0,5]])})))()}},T=S,I=a("2877"),q=a("9989"),L=a("9c40"),M=a("eb85"),A=a("74f7"),E=a("1b41"),_=a("eebe"),H=a.n(_),P=Object(I["a"])(T,n,r,!1,null,null,null);e["default"]=P.exports;H()(P,"components",{QPage:q["a"],QBtn:L["a"],QSeparator:M["a"],QInnerLoading:A["a"],QSpinnerOval:E["a"]})}}]);