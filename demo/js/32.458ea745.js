(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[32],{cd34:function(t,a,e){"use strict";e.r(a);var s=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("q-page",{attrs:{padding:""}},[t.chartData?e("div",[e("p",{staticStyle:{"margin-top":"0"}},[t._v(t._s(t.$t("studies.tasks.dataQuery.dataQueryExplanation")))]),t.plotBar?e("bar-chart",{attrs:{"chart-data":t.chartData,options:t.chartOptions}}):t._e(),t.plotLine?e("line-chart",{attrs:{"chart-data":t.chartData,options:t.chartOptions}}):t._e(),e("div",{staticClass:"row"},[e("q-btn",{staticClass:"col",attrs:{color:"primary",loading:t.loading,label:t.$t("common.send")},on:{click:function(a){return t.submit()}}})],1)],1):t._e()])},n=[],r=e("967e"),c=e.n(r),o=(e("7514"),e("96cf"),e("fa84")),i=e.n(o),l=(e("c5f6"),e("4468")),h=e("1fca"),d={extends:h["a"],props:["chartData","options"],mounted:function(){this.renderChart(this.chartData,this.options)}},u={extends:h["b"],props:["chartData","options"],mounted:function(){this.renderChart(this.chartData,this.options)}},p=e("9bf1"),D=e("6a6d"),k=e("aa9c"),g=e("1e59"),b=e("c1df"),y=e.n(b),m=["#800000","#778000","#118000","#008080","#003780","#080080","#440080","#790080","#800046","#800046"],f={name:"DataQueryPage",props:{studyKey:String,taskId:Number},components:{BarChart:d,LineChart:u},data:function(){return{task:{},taskDescr:{},chartData:null,chartOptions:null,healthData:null,plotLine:!1,plotBar:!1,loading:!1}},mounted:function(){var t=this;return i()(c.a.mark((function a(){var e,s,n,r,o,i,h,d,u,p,k,b,f,v,x,T,w,A,C;return c.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.$q.loading.show(),e=t.studyKey,s=t.taskId,a.next=5,D["a"].getStudyDescription(e);case 5:return n=a.sent,t.taskDescr=n.tasks.find((function(t){return t.id===Number(s)})),a.next=9,D["a"].getStudyParticipation(e);case 9:if(r=a.sent,o=r.taskItemsConsent.find((function(t){return t.taskId===Number(s)})).lastExecuted,i=y()(),"undefined"!==typeof o?i=y()(o):"d"===t.taskDescr.scheduling.intervalType?i.subtract(t.taskDescr.scheduling.interval,"days"):"w"===t.taskDescr.scheduling.intervalType?i.subtract(t.taskDescr.scheduling.interval,"weeks"):"m"===t.taskDescr.scheduling.intervalType?i.subtract(t.taskDescr.scheduling.interval,"months"):"y"===t.taskDescr.scheduling.intervalType&&i.subtract(t.taskDescr.scheduling.interval,"years"),console.log("Retrieving ".concat(t.taskDescr.dataType,", aggregated: ").concat(t.taskDescr.aggregated,", bucket: ").concat(t.taskDescr.bucket)),console.log("Start Date: "+i.toDate()),a.prev=15,!t.taskDescr.aggregated){a.next=28;break}if(!t.taskDescr.bucket||"none"===t.taskDescr.bucket){a.next=23;break}return a.next=20,l["a"].queryAggregated({startDate:i.toDate(),endDate:new Date,dataType:g["a"].toNativeType(t.taskDescr.dataType),bucket:t.taskDescr.bucket});case 20:t.healthData=a.sent,a.next=26;break;case 23:return a.next=25,l["a"].queryAggregated({startDate:i.toDate(),endDate:new Date,dataType:g["a"].toNativeType(t.taskDescr.dataType)});case 25:t.healthData=a.sent;case 26:a.next=31;break;case 28:return a.next=30,l["a"].query({startDate:i.toDate(),endDate:new Date,dataType:g["a"].toNativeType(t.taskDescr.dataType)});case 30:t.healthData=a.sent;case 31:if(console.log("raw health data",t.healthData),h="",t.taskDescr.bucket&&"none"!==t.taskDescr.bucket?h=t.taskDescr.bucket:t.healthData.unit?h=t.healthData.unit:t.healthData.length&&(h=t.healthData[0].unit),d={labels:[],datasets:[]},t.taskDescr.aggregated){if(t.taskDescr.bucket&&"none"!==t.taskDescr.bucket)if("activity"===t.taskDescr.dataType){for(u=[],p=0;p<t.healthData.length;p++)for(k in d.labels.push(t.healthData[p].endDate),t.healthData[p].value)b=u.indexOf(k),b<0&&(b=d.datasets.length,u.push(k),d.datasets.push({label:k,data:[],backgroundColor:m[b]})),f=parseInt(t.healthData[p].value[k].duration/36e5),d.datasets[b].data.push(f);t.chartOptions={maintainAspectRatio:!1,scales:{yAxes:[{stacked:!0,ticks:{beginAtZero:!0}}],xAxes:[{stacked:!0,type:"time",bounds:"data",time:{unit:h}}]}}}else{for(d.datasets.push({label:t.$i18n.t("healthDataTypes."+t.taskDescr.dataType),data:[],backgroundColor:"#800000"}),v=0;v<t.healthData.length;v++)d.labels.push(t.healthData[v].endDate),d.datasets[0].data.push(t.healthData[v].value);t.chartOptions={maintainAspectRatio:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{type:"time",bounds:"data",time:{unit:h}}]}}}else if("activity"===t.taskDescr.dataType){for(T in x=[],d.labels.push(y()(t.healthData.startDate).format("D/M/YY HH:mm")+" to "+y()(t.healthData.endDate).format("D/M/YY HH:mm")),t.healthData.value)w=x.indexOf(T),w<0&&(w=d.datasets.length,x.push(T),d.datasets.push({label:T,data:[],backgroundColor:m[w]})),A=parseInt(t.healthData.value[T].duration/36e5),d.datasets[w].data.push(A);t.chartOptions={maintainAspectRatio:!1,scales:{yAxes:[{stacked:!0,ticks:{beginAtZero:!0}}],xAxes:[{stacked:!0}]}}}else d.datasets.push({label:t.$i18n.t("healthDataTypes."+t.taskDescr.dataType),data:[],backgroundColor:"#800000"}),d.labels.push(y()(t.healthData.startDate).format("D/M/YY HH:mm")+" to "+y()(t.healthData.endDate).format("D/M/YY HH:mm")),d.datasets[0].data.push(t.healthData.value),t.chartOptions={maintainAspectRatio:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}]}};t.plotBar=!0}else{for(d.datasets.push({label:t.$i18n.t("healthDataTypes."+t.taskDescr.dataType),data:[],fill:!1,pointRadius:0,lineTension:0,backgroundColor:"#800000",borderColor:"rgba(128,0,0,0.66)"}),C=0;C<t.healthData.length;C++)d.labels.push(t.healthData[C].endDate),d.datasets[0].data.push(t.healthData[C].value);t.chartOptions={maintainAspectRatio:!1,scales:{yAxes:[{ticks:{beginAtZero:!0}}],xAxes:[{type:"time",bounds:"data"}]}},t.plotLine=!0}t.chartData=d,t.$q.loading.hide(),a.next=45;break;case 40:a.prev=40,a.t0=a["catch"](15),console.error(a.t0),t.$q.loading.hide(),t.$q.notify({color:"negative",message:"Cannot retrieve data: "+a.t0.message,icon:"report_problem"});case 45:case"end":return a.stop()}}),a,null,[[15,40]])})))()},methods:{submit:function(){var t=this;return i()(c.a.mark((function a(){var e,s;return c.a.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.loading=!0,a.prev=1,e=t.studyKey,s=Number(t.taskId),a.next=6,k["a"].sendDataQuery({userKey:p["a"].user._key,studyKey:e,taskId:s,dataType:t.taskDescr.dataType,createdTS:new Date,healthData:t.healthData});case 6:return a.next=8,D["a"].setTaskCompletion(e,s,new Date);case 8:t.$router.push("/home"),a.next=16;break;case 11:a.prev=11,a.t0=a["catch"](1),t.loading=!1,console.error(a.t0),t.$q.notify({color:"negative",message:t.$t("errors.connectionError")+" "+a.t0.message,icon:"report_problem",onDismiss:function(){this.$router.push("/home")}});case 16:case"end":return a.stop()}}),a,null,[[1,11]])})))()}}},v=f,x=e("2877"),T=e("9989"),w=e("9c40"),A=e("eebe"),C=e.n(A),$=Object(x["a"])(v,s,n,!1,null,null,null);a["default"]=$.exports;C()($,"components",{QPage:T["a"],QBtn:w["a"]})}}]);