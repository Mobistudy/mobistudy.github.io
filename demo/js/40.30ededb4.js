(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[40],{b224:function(e,t,a){"use strict";a.r(t);var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("q-page",{attrs:{id:"main"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:!e.isDownloading,expression:"!isDownloading"}]},[a("p",{staticClass:"q-pa-md"},[e._v(e._s(e.$t("studies.tasks.miband3.chartsIntro")))]),a("div",{staticClass:"text-center text-h6"},[e._v("\n      "+e._s(e.$t("studies.tasks.miband3.lineChart"))+"\n    ")]),a("div",{staticClass:"q-pa-md"},[a("canvas",{ref:"lineChart",staticStyle:{margin:"0 auto","padding-right":"2rem"},attrs:{height:"320"}}),a("div",{staticClass:"row justify-around"},[a("q-btn",{attrs:{label:"-12 "+e.$t("studies.tasks.miband3.hours"),color:"secondary",disable:e.disableMinus},on:{click:function(t){e.lineChartAdd(-12)}}}),a("q-btn",{attrs:{label:"+12 "+e.$t("studies.tasks.miband3.hours"),color:"secondary",disable:e.disablePlus},on:{click:function(t){e.lineChartAdd(12)}}})],1)]),a("q-separator"),a("div",{staticClass:"text-center text-h6"},[e._v("\n      "+e._s(e.$t("studies.tasks.miband3.pieChart"))+"\n    ")]),a("div",{staticClass:"q-pa-md"},[a("canvas",{ref:"pieChart",attrs:{height:"270"}})]),a("q-separator"),a("div",{staticClass:"q-my-md row justify-around"},[a("q-btn",{attrs:{label:e.$t("common.discard"),flat:"",color:"secondary"},on:{click:function(t){return e.skipSend()}}}),a("q-btn",{attrs:{label:e.$t("common.send"),color:"primary"},on:{click:function(t){return e.sendData()}}})],1)],1),a("q-inner-loading",{attrs:{showing:e.isDownloading}},[a("div",{staticClass:"text-overline"},[e._v(e._s(e.$t("studies.tasks.miband3.dataDownload")))]),a("q-spinner-oval",{attrs:{size:"50px",color:"primary"}})],1),a("q-inner-loading",{attrs:{showing:e.isSending}},[a("div",{staticClass:"text-overline"},[e._v(e._s(e.$t("studies.tasks.miband3.dataSending")))]),a("q-spinner-oval",{attrs:{size:"50px",color:"primary"}})],1)],1)},r=[],s=(a("a9e3"),a("d3b7"),a("e6cf"),a("6374")),i=a.n(s),o=(a("96cf"),a("c973")),c=a.n(o),u=a("e995"),d=a("30ef"),l=a.n(d);function h(e){switch(e){case 1:case 16:return"walk";case 3:return"not_worn";case 6:return"charging";case 80:case 90:case 89:case 91:case 92:case 96:return"sedentary";case 98:case 82:return"running";case 17:return"activity_high";case 106:case 112:case 121:case 122:case 123:return"sleep";default:return"unknown"}}var p=a("6a6d"),m=a("9bf1"),b=a("aa9c"),f=a("c1df"),v=a.n(f),g=["#800000","#778000","#118000","#008080","#003780","#080080","#440080","#790080","#800046","#800046"],w=[],k=30,x={type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},options:{animation:{animateScale:!0}},indexes:[],maxIndex:-1,reset:function(){this.data.datasets.data=[],this.data.datasets.backgroundColor=[],this.data.labels=[],this.indexes=[],this.maxIndex=-1}},C={hrs:[],steps:[],intensities:[],labels:[],reset:function(){this.hrs=[],this.steps=[],this.intensities=[],this.labels=[]}},y={name:"MiBand3DataDownloadPage",props:{studyKey:String,taskId:Number},data:function(){return{startDate:new Date,deviceInfo:{},isDownloading:!1,lineChart:void 0,currentStartHour:0,currentEndHour:12,disableMinus:!0,disablePlus:!1,isSending:!1}},methods:{downloadData:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.isDownloading=!0,w=[],x.reset(),C.reset(),t.next=6,e.getDateToUseForDownload();case 6:return e.startDate=t.sent,t.prev=7,t.next=10,u["a"].getDeviceInfo();case 10:return e.deviceInfo=t.sent,t.next=13,u["a"].getStoredData(e.startDate,e.dataCallback);case 13:return t.prev=13,t.next=16,u["a"].disconnect();case 16:t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](13),console.error("cannot disconnect miband3",t.t0);case 21:if(!(w.length<k)){t.next=26;break}return t.next=24,e.storeDownloadDate(e.startDate);case 24:return e.$router.push({name:"notEnoughDataPage"}),t.abrupt("return");case 26:e.createPieChart(),e.renderLineChart(e.currentStartHour,e.currentEndHour),e.isDownloading=!1,t.next=35;break;case 31:t.prev=31,t.t1=t["catch"](7),console.error("cannot download data",t.t1),e.showErrorDialog();case 35:case"end":return t.stop()}}),t,null,[[7,31],[13,18]])})))()},storeDownloadDate:function(e){var t=this;return c()(regeneratorRuntime.mark((function a(){var n;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,p["a"].getStudyParticipationTaskItemConsent(t.studyKey,t.taskId);case 2:return n=a.sent,n.lastMiband3SampleTS=e,a.next=6,p["a"].setStudyParticipationTaskItemConsent(t.studyKey,t.taskId,n);case 6:return a.abrupt("return",n);case 7:case"end":return a.stop()}}),a)})))()},getLatestDownloadedSampleDate:function(){return w[w.length-1].date},getDateToUseForDownload:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){var a,n,r,s,i,o,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,p["a"].getStudyParticipationTaskItemConsent(e.studyKey,e.taskId);case 2:if(n=t.sent,r=n.lastMiband3SampleTS,!r){t.next=8;break}a=new Date(r),t.next=13;break;case 8:return t.next=10,p["a"].getTaskDescription(e.studyKey,e.taskId);case 10:s=t.sent,i=s.lastExecuted,i?a=new Date(i):(a=v()(),o=s.scheduling.intervalType,c=s.scheduling.interval,"d"===o?a.subtract(c,"days"):"w"===o?a.subtract(c,"weeks"):"m"===o?a.subtract(c,"months"):"y"===o&&a.subtract(c,"years"),a=a.toDate());case 13:return t.abrupt("return",a);case 14:case"end":return t.stop()}}),t)})))()},renderLineChart:function(e,t){C.reset();var a=60*e,n=60*t-1;n>=w.length&&(n=w.length-1);for(var r=a;r<=n;r++){var s=w[r];this.addToLineChart(s.hr,s.intensity,s.steps,s.date)}this.updateLineChartReferences(),this.updatePlusMinusButtons()},showErrorDialog:function(){var e=this;this.$q.dialog({title:this.$t("errors.error"),message:this.$t("studies.tasks.miband3.dataDownloadError"),cancel:this.$t("common.cancel"),ok:this.$t("common.retry"),persistent:!0}).onOk((function(){e.downloadData()})).onCancel((function(){e.cancelTask()}))},cancelTask:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,u["a"].disconnect();case 3:t.next=8;break;case 5:t.prev=5,t.t0=t["catch"](0),console.error("cannot disconnect miband3",t.t0);case 8:e.$router.push({name:"tasker"});case 9:case"end":return t.stop()}}),t,null,[[0,5]])})))()},dataCallback:function(e){w.push(e)},addToLineChart:function(e,t,a,n){e>30&&e<210&&C.hrs.push({x:n,y:e}),C.intensities.push({x:n,y:t}),C.steps.push({x:n,y:a}),C.labels.push(n)},createPieChart:function(){var e,t=i()(w);try{for(t.s();!(e=t.n()).done;){var a=e.value,n=a.activityType,r=h(n);if(void 0===x.indexes[r]){x.maxIndex++;var s=x.maxIndex;x.indexes[r]=s,x.data.datasets[0].data[s]=1,x.data.datasets[0].backgroundColor[s]=g[s],x.data.labels.push(this.$t("studies.tasks.miband3.activityTypes."+r))}else{var o=x.indexes[r];x.data.datasets[0].data[o]++}}}catch(u){t.e(u)}finally{t.f()}var c=this.$refs.pieChart;new l.a(c,x)},updateLineChartReferences:function(){this.lineChart.data.datasets[0].data=C.hrs,this.lineChart.data.datasets[1].data=C.intensities,this.lineChart.data.datasets[2].data=C.steps,this.lineChart.data.labels=C.labels,this.lineChart.update()},createActivityLineChart:function(){var e=this.$refs.lineChart;this.lineChart=new l.a.Scatter(e,{type:"scatter",data:{labels:C.labels,datasets:[{label:this.$t("studies.tasks.miband3.hrs"),data:C.hrs,backgroundColor:"#C74038",borderColor:"#C74038",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.intensities"),data:C.intensities,backgroundColor:"#4038C7",borderColor:"#4038C7",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.steps"),data:C.steps,backgroundColor:"#38C740",borderColor:"#38C740",borderWidth:0,pointRadius:1,fill:!1,lineTension:0}]},options:{responsive:!0,title:{display:!1},scales:{xAxes:[{type:"time",time:{displayFormats:{quarter:"HH:MM:SS"}},scaleLabel:{display:!0,lineChartLabelstring:"Date"}}],yAxes:[{scaleLabel:{display:!0,lineChartLabelstring:"value"}}]}}}),this.lineChart.update()},lineChartAdd:function(e){this.currentStartHour+=e,this.currentEndHour+=e,this.renderLineChart(this.currentStartHour,this.currentEndHour),this.updatePlusMinusButtons()},updatePlusMinusButtons:function(){0===this.currentStartHour?this.disableMinus=!0:this.disableMinus=!1,this.currentEndHour>=w.length/60?this.disablePlus=!0:this.disablePlus=!1},skipSend:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){var a,n;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.storeDownloadDate(e.getLatestDownloadedSampleDate());case 2:return a=e.studyKey,n=Number(e.taskId),t.next=6,p["a"].setTaskCompletion(a,n,new Date);case 6:e.$router.push({name:"tasker"});case 7:case"end":return t.stop()}}),t)})))()},sendData:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){var a,n,r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.isSending=!0,t.next=3,e.delay(2);case 3:return t.prev=3,a=e.studyKey,n=Number(e.taskId),t.next=8,b["a"].sendMiBand3Data({userKey:m["a"].user._key,studyKey:a,taskId:n,createdTS:new Date,device:e.deviceInfo,miband3Data:w});case 8:return t.next=10,p["a"].setTaskCompletion(a,n,new Date);case 10:return t.next=12,e.storeDownloadDate(e.getLatestDownloadedSampleDate());case 12:return r=t.sent,t.next=15,b["a"].updateTaskItemConsent(a,n,r);case 15:e.isSending=!1,e.$router.push({name:"tasker"}),t.next=24;break;case 19:t.prev=19,t.t0=t["catch"](3),e.isSending=!1,console.error(t.t0),e.$q.notify({color:"negative",message:e.$t("errors.connectionError")+" "+t.t0.message,icon:"report_problem",onDismiss:function(){this.$router.push({name:"tasker"})}});case 24:case"end":return t.stop()}}),t,null,[[3,19]])})))()},delay:function(e){return c()(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,a){setTimeout((function(){t()}),1e3*e)})));case 1:case"end":return t.stop()}}),t)})))()}},mounted:function(){var e=this;return c()(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.createActivityLineChart(),t.next=3,e.downloadData();case 3:case"end":return t.stop()}}),t)})))()},beforeDestroy:function(){return c()(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,u["a"].disconnect();case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.error("cannot disconnect miband3",e.t0);case 8:case"end":return e.stop()}}),e,null,[[0,5]])})))()}},D=y,S=a("2877"),$=a("9989"),R=a("9c40"),T=a("eb85"),I=a("74f7"),q=a("1b41"),L=a("eebe"),P=a.n(L),_=Object(S["a"])(D,n,r,!1,null,null,null);t["default"]=_.exports;P()(_,"components",{QPage:$["a"],QBtn:R["a"],QSeparator:T["a"],QInnerLoading:I["a"],QSpinnerOval:q["a"]})}}]);