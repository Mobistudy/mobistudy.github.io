(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[3],{"5b54":function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-page",{attrs:{padding:""}},[s("q-pull-to-refresh",{attrs:{label:"Default spinner"},on:{refresh:e.refresh}},[e.newstudies?s("q-banner",{staticClass:"bg-warning text-white q-mb-sm",attrs:{rounded:"","inline-actions":"",icon:"new_releases",type:"warning"},scopedSlots:e._u([{key:"action",fn:function(){return[s("q-btn",{attrs:{color:"blue",label:e.$t("studies.checkNewStusy"),to:"studies"}})]},proxy:!0}],null,!1,845094109)},[e._v("\n      "+e._s(e.$t("studies.newStudy"))+"!\n      ")]):e._e(),e.nostudies?s("q-item-label",{staticClass:"q-title fixed-center"},[e._v("\n      "+e._s(e.$t("studies.noStudies"))+"\n    ")]):s("div",{attrs:{highlight:""}},[s("q-item-label",{attrs:{header:""}},[e._v("\n        "+e._s(e.$t("studies.tasks.pendingTasks"))+"\n      ")]),e._l(e.studiesInfo,(function(t){return s("q-list",{key:"upcoming-"+t._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[e._v(e._s(t.generalities.title[e.$root.$i18n.locale]))]),e._l(e.tasks.upcoming,(function(n,a){return s("taskListItem",{key:"item-"+a,attrs:{task:e.filterTask(n,t),isMissedTask:!1}})}))],2),0===e.tasks.upcoming.length?s("q-item",[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"primary",name:"check"}})],1),s("q-item-section",[s("q-item-label",[e._v(e._s(e.$t("studies.tasks.noPendingTasks")))])],1)],1):e._e()],1)})),s("q-item-label",{attrs:{header:""}},[e._v("\n        "+e._s(e.$t("studies.tasks.missedTasks"))+"\n      ")]),e._l(e.studiesInfo,(function(t){return s("q-list",{key:"missed-"+t._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[e.tasks.missed.length>0?s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[e._v(e._s(t.generalities.title[e.$root.$i18n.locale]))]),e._l(e.tasks.missed,(function(n,a){return s("taskListItem",{key:"item-"+t._key+"-"+a,attrs:{task:e.filterTask(n,t),isMissedTask:!0}})}))],2):s("q-item",[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"primary",name:"check"}})],1),s("q-item-section",[s("q-item-label",[e._v(e._s(e.$t("studies.tasks.noMissedTasks")))])],1)],1)],1)})),e.tasks.alwaysOn.length>0?s("div",[s("q-item-label",{attrs:{header:""}},[e._v("\n          "+e._s(e.$t("studies.tasks.alwaysOnTasks"))+"\n        ")]),e._l(e.studiesInfo,(function(t){return s("q-list",{key:"alwayson-"+t._key,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[s("q-item-section",[s("q-item-label",{attrs:{header:"",overline:""}},[e._v(e._s(t.generalities.title[e.$root.$i18n.locale]))]),e._l(e.tasks.alwaysOn,(function(n,a){return s("taskListItem",{key:"item-"+a,attrs:{task:e.filterTask(n,t),isMissedTask:!1}})}))],2)],1)}))],2):e._e()],2)],1),this.tasks.completedStudyAlert?s("q-dialog",{attrs:{maximized:""},model:{value:e.completedStudyModal,callback:function(t){e.completedStudyModal=t},expression:"completedStudyModal"}},[s("div",{staticClass:"q-pa-lg text-center",staticStyle:{"background-color":"white"}},[s("div",{staticClass:"text-h4 q-mb-md"},[e._v(e._s(e.$t("studies.studyCompletedHeadline"))+"!")]),s("div",[s("img",{staticStyle:{width:"30vw","max-width":"150px"},attrs:{src:"icons/confetti.svg"}})]),s("p",{domProps:{innerHTML:e._s(e.$t("studies.studyCompletedText",{studyname:e.completedStudyTitle}))}}),s("q-btn",{attrs:{color:"primary",label:e.$t("common.close")},on:{click:function(t){return e.studyCompleted()}}})],1)]):e._e()],1)},a=[],i=s("6374"),r=s.n(i),o=(s("96cf"),s("c973")),u=s.n(o),c=function(){var e=this,t=e.$createElement,s=e._self._c||t;return this.task.studyKey?s("q-item",{nativeOn:{click:function(t){return e.changeRoute(t)}}},[s("q-item-section",{attrs:{avatar:""}},[s("q-icon",{attrs:{color:"grey",name:e.icon}})],1),s("q-item-section",[s("q-item-label",[e._v(e._s(e.title))]),s("q-item-label",{attrs:{caption:""}},[e._v(e._s(e.main))])],1),this.isMissedTask?s("q-item-section",{attrs:{side:"",top:""}},[e._v("\n    "+e._s(e.timeRemaining)+"\n  ")]):e._e()],1):e._e()},d=[],l=s("c1df"),m=s.n(l),h={name:"TaskListItem",props:["task","isMissedTask"],data:function(){return{icon:void 0,title:void 0,main:void 0}},methods:{changeRoute:function(){var e=this.task.type,t=this.task.studyKey,s=this.task.taskId,n=this.task.formKey;if("form"===e)this.$router.push({name:"formIntro",params:{studyKey:t,taskId:s,formKey:n},query:{icon:this.icon,title:this.title}});else if("smwt"===e)this.$router.push({name:"smwtIntro",params:{studyKey:t,taskId:s},query:{icon:this.icon,title:this.title}});else if("qcst"===e)this.$router.push({name:"qcstIntro",params:{studyKey:t,taskId:s},query:{icon:this.icon,title:this.title}});else if("miband3"===e)this.$router.push({name:"miband3Intro",params:{studyKey:t,taskId:s},query:{icon:this.icon,title:this.title}});else if("po60"===e)this.$router.push({name:"po60Intro",params:{studyKey:t,taskId:s},query:{icon:this.icon,title:this.title}});else{if("dataQuery"!==e)throw new Error("Could not changeRoute with task type.");this.$router.push({name:"dataQueryIntro",params:{taskId:s,studyKey:t},query:{icon:this.icon,title:this.title}})}}},created:function(){"dataQuery"===this.task.type?(this.title=this.$i18n.t("studies.tasks.dataQuery.shortTitle"),this.main=this.$i18n.t("studies.tasks.dataQuery.shortDescription"),this.icon="insert_chart_outlined"):"form"===this.task.type?(this.title=this.task.formName[this.$root.$i18n.locale],this.main=this.$i18n.t("studies.tasks.form.shortDescription"),this.icon="format_list_bulleted"):"smwt"===this.task.type?(this.title=this.$i18n.t("studies.tasks.smwt.shortTitle"),this.main=this.$i18n.t("studies.tasks.smwt.shortDescription"),this.icon="directions_walk"):"qcst"===this.task.type?(this.title=this.$i18n.t("studies.tasks.qcst.shortTitle"),this.main=this.$i18n.t("studies.tasks.qcst.shortDescription"),this.icon="layers"):"miband3"===this.task.type?(this.title=this.$i18n.t("studies.tasks.miband3.shortTitle"),this.main=this.$i18n.t("studies.tasks.miband3.shortDescription"),this.icon="watch"):"po60"===this.task.type&&(this.title=this.$i18n.t("studies.tasks.po60.shortTitle"),this.main=this.$i18n.t("studies.tasks.po60.shortDescription"),this.icon="touch_app")},computed:{timeRemaining:function(){return"Due "+m()(this.task.due).fromNow()}}},p=h,y=s("2877"),f=s("66e5"),k=s("4074"),v=s("0016"),g=s("0170"),w=s("eebe"),b=s.n(w),S=Object(y["a"])(p,c,d,!1,null,null,null),_=S.exports;b()(S,"components",{QItem:f["a"],QItemSection:k["a"],QIcon:v["a"],QItemLabel:g["a"]});var q=s("9bf1"),x=s("6a6d"),$=s("aa9c"),T=(s("4de4"),s("7db0"),s("c975"),s("fb6a"),s("cca6"),s("d3b7"),s("25f0"),s("8847")),D=s("55b4"),I=s("ee76"),O=s("0967"),K=s("1e59");function C(e,t){var s,n={upcoming:[],missed:[],alwaysOn:[]},a=r()(e);try{var i=function(){var e=s.value;if("accepted"===e.currentStatus){var a=t.find((function(t){return t._key===e.studyKey}));if((new Date).toISOString()>a.generalities.endDate+"T23:59:59")return n.completedStudyAlert={studyTitle:a.generalities.title,studyPart:e},"continue";var i,o=a.tasks.filter((function(t){var s=e.taskItemsConsent.find((function(e){return e.taskId===t.id}));return s.consented})),u=!0,c=r()(o);try{var d=function(){var t=i.value;if(t.scheduling.alwaysOn){if(Q(e.acceptedTS,t.scheduling)){u=!1;var s={type:t.type,studyKey:a._key,taskId:t.id,alwaysOn:!0};"form"===t.type&&(s.formName=t.formName,s.formKey=t.formKey),n.alwaysOn.push(s)}}else{var r,o,c,d=l(new Date(a.generalities.endDate)).add(1,"days").toDate(),m=R(e.acceptedTS,d,t.scheduling),h=m.between(l().startOf("day").toDate(),l(d).endOf("day").toDate());if(!(h.length>0))return"continue";if(u=!1,"dataQuery"===t.type){if(O["b"].is.ios&&K["a"].isAndroidOnly(t.dataType))return"continue";if(O["b"].is.android&&K["a"].isIOSOnly(t.dataType))return"continue"}if(e.taskItemsConsent){var p=e.taskItemsConsent.find((function(e){return e.taskId===t.id}));p&&p.lastExecuted&&(o=l(new Date(p.lastExecuted)))}o?(r=m.between(o.toDate(),l().startOf("day").toDate()),r=r.length>0?r[r.length-1]:null):r=m.before(l().startOf("day").toDate()),o&&o.isAfter(l().startOf("day"))?c=null:(c=m.between(l().startOf("day").toDate(),l().endOf("day").toDate()),c=c.length>0?c[0]:null);var y={type:t.type,studyKey:a._key,taskId:t.id};"form"===t.type&&(y.formName=t.formName,y.formKey=t.formKey),null!==c?n.upcoming.push(Object.assign({missed:!1,due:c},y)):null!==r&&n.missed.push(Object.assign({missed:!0,due:r},y))}};for(c.s();!(i=c.n()).done;)d()}catch(m){c.e(m)}finally{c.f()}u&&(n.completedStudyAlert={studyTitle:a.generalities.title,studyPart:e})}};for(a.s();!(s=a.n()).done;)i()}catch(o){a.e(o)}finally{a.f()}return n}function Q(e,t){if(!e||!t)throw new Error("both arguments must be specified in isAlwaysOnTaskDue");var s=new Date,n=new Date(e);if("consent"!==t.startEvent)throw new Error("The only start event recognised is consent");if(t.startDelaySecs&&(n=new Date(n.getTime()+1e3*t.startDelaySecs)),t.untilSecs){var a=new Date(n.getTime()+1e3*t.untilSecs);if(s>n&&s<a)return!0}else if(s>n)return!0;return!1}function R(e,t,s){var n=l(e);if("consent"!==s.startEvent)throw new Error("The only start event recognised is consent");s.startDelaySecs&&(n=n.clone().add(s.startDelaySecs,"s"));var a,i=l(t);if(s.untilSecs){var r=n.clone().add(s.untilSecs,"s");r.isBefore(i)&&(i=r.clone())}switch(s.intervalType){case"y":a=D["a"].YEARLY;break;case"m":a=D["a"].MONTHLY;break;case"w":a=D["a"].WEEKLY;break;case"d":a=D["a"].DAILY;break;default:throw new Error("No Frequency Specified")}var o=[];if(s.weekDays)for(var u=0;u<s.weekDays.length;u++)switch(s.weekDays[u]){case"mo":o.push(D["a"].MO);break;case"tu":o.push(D["a"].TU);break;case"we":o.push(D["a"].WE);break;case"th":o.push(D["a"].TH);break;case"fr":o.push(D["a"].FR);break;case"sa":o.push(D["a"].SA);break;case"su":o.push(D["a"].SU);break}var c={};return c.dtstart=n.toDate(),c.until=i.toDate(),c.freq=a,s.interval&&(c.interval=s.interval),s.months&&(c.bymonth=s.months),s.monthDays&&(c.bymonthday=s.monthDays),c.byweekday=o,s.occurrences&&(c.count=s.occurrences),new D["a"](c)}function E(){return A.apply(this,arguments)}function A(){return A=u()(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.abrupt("return",I["a"].cancelAll());case 1:case"end":return e.stop()}}),e)}))),A.apply(this,arguments)}function M(e,t,s){return L.apply(this,arguments)}function L(){return L=u()(regeneratorRuntime.mark((function e(t,s,n){var a,i,o,u,c,d;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:a=[],i=[],o=r()(s.tasks),e.prev=3,c=function(){var e=u.value;if("dataQuery"===e.type){if(O["b"].is.ios&&K["a"].isAndroidOnly(e.dataType))return"continue";if(O["b"].is.android&&K["a"].isIOSOnly(e.dataType))return"continue"}if(e.scheduling.alwaysOn)return"continue";for(var r=R(t,new Date(s.generalities.endDate),e.scheduling),o=r.between(new Date,new Date(s.generalities.endDate),!0),c=0;c<o.length&&c<1e3;c++){var d=o[c],m=l(d).startOf("minute").toDate(),h="";if(s._key){var p=s._key.toString();h+=p.slice(-4)}h+=e.id,h+=c;var y=void 0;if(n.taskItemsConsent){var f=n.taskItemsConsent.find((function(t){return t.taskId===e.id}));f&&f.lastExecuted&&(y=l(new Date(f.lastExecuted)))}var k=!1;y&&l(m).isBetween(l().startOf("day"),l().endOf("day"))&&y.isBetween(l().startOf("day"),l(m))&&(k=!0),-1!==i.indexOf(l(m).unix())||k||(i.push(l(m).unix()),a.push({id:parseInt(h),title:T["b"].t("studies.scheduling.due"),text:T["b"].t("studies.scheduling.start"),foreground:!0,trigger:{at:m}}))}},o.s();case 6:if((u=o.n()).done){e.next=12;break}if(d=c(),"continue"!==d){e.next=10;break}return e.abrupt("continue",10);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e["catch"](3),o.e(e.t0);case 17:return e.prev=17,o.f(),e.finish(17);case 20:return e.next=22,I["a"].schedule(a);case 22:case"end":return e.stop()}}),e,null,[[3,14,17,20]])}))),L.apply(this,arguments)}var N={name:"TaskerPage",components:{taskListItem:_},props:["rescheduleTasks","checkNewStudies"],data:function(){return{nostudies:!1,newstudies:!1,tasks:{upcoming:[],missed:[],alwaysOn:[],completedStudyAlert:void 0,completedStudyTitle:void 0},completedStudyModal:!1,studiesInfo:[]}},created:function(){var e=this;return u()(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.load();case 1:case"end":return t.stop()}}),t)})))()},methods:{refresh:function(e){var t=this,s=this.$q.notify({group:!1,spinner:!0,type:"ongoing",message:this.$i18n.t("studies.searchingForStudies")+"...",timeout:0});setTimeout((function(){t.checkForStudy(),e(),s({type:t.newstudies?"positive":"warning",spinner:!1,message:t.newstudies?t.$i18n.t("studies.newStudyInvite"):t.$i18n.t("studies.foundNoStudies"),timeout:1e3}),t.loading=!1}),1e3)},filterTask:function(e,t){return e.studyKey===t._key?e:""},checkForStudy:function(){var e=this;return u()(regeneratorRuntime.mark((function t(){var s;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!e.checkNewStudies){t.next=11;break}return t.prev=1,t.next=4,$["a"].getNewStudiesKeys();case 4:s=t.sent,s.length>0?e.newstudies=!0:e.newstudies=!1,t.next=11;break;case 8:t.prev=8,t.t0=t["catch"](1),console.error("Cannot connect to server, but thats OK",t.t0);case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()},load:function(){var e=this;return u()(regeneratorRuntime.mark((function t(){var s,n,a,i,o,u,c,d,l;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.$q.loading.show(),t.prev=1,e.checkForStudy(),!e.rescheduleTasks){t.next=25;break}return t.next=6,E();case 6:return t.prev=6,t.next=9,$["a"].getProfile(q["a"].user._key);case 9:if(s=t.sent,s.studies&&0!==s.studies.length){t.next=18;break}return t.next=13,x["a"].setStudiesParticipation([]);case 13:return e.$q.loading.hide(),e.nostudies=!0,t.abrupt("return");case 18:return t.next=20,x["a"].setStudiesParticipation(s.studies);case 20:t.next=25;break;case 22:t.prev=22,t.t0=t["catch"](6),console.error("Cannot connect to server, but thats OK",t.t0);case 25:return t.next=27,x["a"].getStudiesParticipation();case 27:if(n=t.sent,n){t.next=32;break}return e.$q.loading.hide(),e.nostudies=!0,t.abrupt("return");case 32:a=[],i=[],o=r()(n),t.prev=35,o.s();case 37:if((u=o.n()).done){t.next=57;break}return c=u.value,t.next=41,x["a"].getStudyDescription(c.studyKey);case 41:if(d=t.sent,d){t.next=51;break}return t.next=45,$["a"].getStudyDescription(c.studyKey);case 45:return d=t.sent,t.next=48,x["a"].setStudyDescription(c.studyKey,d);case 48:if("accepted"!==c.currentStatus||e.rescheduleTasks||!c.reminders){t.next=51;break}return t.next=51,M(new Date(c.acceptedTS),d,c);case 51:if("accepted"!==c.currentStatus||!e.rescheduleTasks||!c.reminders){t.next=54;break}return t.next=54,M(new Date(c.acceptedTS),d,c);case 54:"accepted"===c.currentStatus&&(a.push(c),i.push(d),e.studiesInfo.push(d));case 55:t.next=37;break;case 57:t.next=62;break;case 59:t.prev=59,t.t1=t["catch"](35),o.e(t.t1);case 62:return t.prev=62,o.f(),t.finish(62);case 65:if(0!==i.length){t.next=69;break}return e.$q.loading.hide(),e.nostudies=!0,t.abrupt("return");case 69:l=C(a,i),e.tasks=l,l.completedStudyAlert&&(e.completedStudyTitle=l.completedStudyAlert.studyTitle[e.$root.$i18n.locale],e.completedStudyModal=!0),e.$q.loading.hide(),t.next=80;break;case 75:t.prev=75,t.t2=t["catch"](1),console.error(t.t2),e.$q.loading.hide(),e.$q.dialog({title:e.$i18n.t("errors.error"),message:e.$i18n.t("errors.generalError"),color:"warning",ok:e.$i18n.t("common.retry"),preventClose:!0}).onOk((function(){e.load()}));case 80:case"end":return t.stop()}}),t,null,[[1,75],[6,22],[35,59,62,65]])})))()},studyCompleted:function(){var e=this;return u()(regeneratorRuntime.mark((function t(){var s;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return s=e.tasks.completedStudyAlert.studyPart,s.currentStatus="completed",s.completedTS=new Date,t.prev=3,t.next=6,$["a"].updateStudyStatus(q["a"].user._key,s.studyKey,s);case 6:return delete s.extraItemsConsent,delete s.taskItemsConsent,t.next=10,x["a"].setStudyParticipation(s);case 10:e.load(),e.completedStudyModal=!1,t.next=18;break;case 14:t.prev=14,t.t0=t["catch"](3),console.error("Cannot set the study as completed",t.t0),e.$q.notify({color:"negative",message:e.$i18n.t("errors.connectionError")+": "+t.t0.message,icon:"report_problem"});case 18:case"end":return t.stop()}}),t,null,[[3,14]])})))()}}},P=N,F=s("9989"),B=s("59d7"),Y=s("54e1"),j=s("9c40"),H=s("1c1c"),J=s("24e8"),U=Object(y["a"])(P,n,a,!1,null,"8dcf7428",null);t["default"]=U.exports;b()(U,"components",{QPage:F["a"],QPullToRefresh:B["a"],QBanner:Y["a"],QBtn:j["a"],QItemLabel:g["a"],QList:H["a"],QItemSection:k["a"],QItem:f["a"],QIcon:v["a"],QDialog:J["a"]})}}]);