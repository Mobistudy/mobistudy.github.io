(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[3],{"5b54":function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t._self._c;return e("q-page",{attrs:{padding:""}},[e("q-pull-to-refresh",{attrs:{label:"Default spinner"},on:{refresh:t.refresh}},[t.newstudies?e("q-banner",{staticClass:"bg-warning text-white q-mb-sm",attrs:{rounded:"","inline-actions":"",icon:"new_releases",type:"warning"},scopedSlots:t._u([{key:"action",fn:function(){return[e("q-btn",{staticClass:"mobibtn",attrs:{color:"blue",label:t.$t("studies.checkNewStusy"),to:"studies"}})]},proxy:!0}],null,!1,240536780)},[e("span",{staticClass:"mobitxt2 text-weight-bold"},[t._v(t._s(t.$t("studies.newStudyAvailable"))+"!")])]):t._e(),t.nostudies?e("q-item-label",{staticClass:"q-title fixed-center mobitxt2"},[t._v("\n      "+t._s(t.$t("studies.noStudies"))+"\n    ")]):e("div",{attrs:{highlight:""}},[e("q-item-label",{staticClass:"mobitxt2",attrs:{header:""}},[t._v("\n        "+t._s(t.$t("studies.tasks.pendingTasks"))+"\n      ")]),t._l(t.studiesInfo,(function(s){return e("q-list",{key:`upcoming-${s._key}`,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[e("q-item-section",[e("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(s.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.upcoming,(function(i,a){return e("taskListItem",{key:`item-${a}`,attrs:{task:t.filterTask(i,s),isMissedTask:!1}})}))],2),0===t.tasks.upcoming.length?e("q-item",[e("q-item-section",{attrs:{avatar:""}},[e("q-icon",{attrs:{color:"primary",name:"check"}})],1),e("q-item-section",[e("q-item-label",{staticClass:"mobitxt1"},[t._v(t._s(t.$t("studies.tasks.noPendingTasks")))])],1)],1):t._e()],1)})),e("q-item-label",{staticClass:"mobitxt2",attrs:{header:""}},[t._v("\n        "+t._s(t.$t("studies.tasks.missedTasks"))+"\n      ")]),t._l(t.studiesInfo,(function(s){return e("q-list",{key:`missed-${s._key}`,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[t.tasks.missed.length>0?e("q-item-section",[e("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(s.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.missed,(function(i,a){return e("taskListItem",{key:`item-${s._key}-${a}`,attrs:{task:t.filterTask(i,s),isMissedTask:!0}})}))],2):e("q-item",[e("q-item-section",{attrs:{avatar:""}},[e("q-icon",{attrs:{color:"primary",name:"check"}})],1),e("q-item-section",[e("q-item-label",{staticClass:"mobitxt1"},[t._v(t._s(t.$t("studies.tasks.noMissedTasks")))])],1)],1)],1)})),t.tasks.alwaysOn.length>0?e("div",[e("q-item-label",{staticClass:"mobitxt2",attrs:{header:""}},[t._v("\n          "+t._s(t.$t("studies.tasks.alwaysOnTasks"))+"\n        ")]),t._l(t.studiesInfo,(function(s){return e("q-list",{key:`alwayson-${s._key}`,staticClass:"q-mt-sm",attrs:{padding:"",bordered:""}},[e("q-item-section",[e("q-item-label",{attrs:{header:"",overline:""}},[t._v(t._s(s.generalities.title[t.$root.$i18n.locale]))]),t._l(t.tasks.alwaysOn,(function(i,a){return e("taskListItem",{key:`item-${a}`,attrs:{task:t.filterTask(i,s),isMissedTask:!1}})}))],2)],1)}))],2):t._e()],2)],1),this.tasks.completedStudyAlert?e("q-dialog",{attrs:{maximized:""},model:{value:t.completedStudyModal,callback:function(e){t.completedStudyModal=e},expression:"completedStudyModal"}},[e("div",{staticClass:"q-pa-lg text-center",staticStyle:{"background-color":"white"}},[e("div",{staticClass:"mobitxt2 q-mb-md"},[t._v(t._s(t.$t("studies.studyCompletedHeadline"))+"!")]),e("div",[e("img",{staticStyle:{width:"30vw","max-width":"150px"},attrs:{src:"imgs/confetti.svg"}})]),e("p",{staticClass:"mobitxt1",domProps:{innerHTML:t._s(t.$t("studies.studyCompletedText",{studyname:t.completedStudyTitle}))}}),e("q-btn",{attrs:{color:"primary",label:t.$t("common.close")},on:{click:function(e){return t.studyCompleted()}}})],1)]):t._e()],1)},a=[],n=(s("ddb0"),s("14d9"),function(){var t=this,e=t._self._c;return this.task.studyKey?e("q-item",{nativeOn:{click:function(e){return t.changeRoute.apply(null,arguments)}}},[e("q-item-section",{attrs:{avatar:""}},[e("q-icon",{staticStyle:{"font-size":"2.5em"},attrs:{color:"grey",name:t.icon}})],1),e("q-item-section",[e("q-item-label",{staticClass:"mobitxt1"},[t._v(t._s(t.title))]),e("q-item-label",{attrs:{caption:""}},[t._v(t._s(t.main))])],1),this.isMissedTask?e("q-item-section",{attrs:{side:"",top:""}},[t._v("\n    "+t._s(t.timeRemaining)+"\n  ")]):t._e()],1):t._e()}),o=[],r=(s("d9e2"),{name:"TaskListItem",props:["task","isMissedTask"],data(){return{icon:void 0,title:void 0,main:void 0}},methods:{changeRoute:function(){const t=this.task.type,e=this.task.studyKey,s=this.task.taskId,i=this.task.formKey,a={icon:this.icon,title:this.title};if("form"===t)this.$router.push({name:"formIntro",params:{studyKey:e,taskId:s,formKey:i},query:a});else if("smwt"===t)this.$router.push({name:"smwtIntro",params:{studyKey:e,taskId:s},query:a});else if("qcst"===t)this.$router.push({name:"qcstIntro",params:{studyKey:e,taskId:s},query:a});else if("miband3"===t)this.$router.push({name:"miband3Intro",params:{studyKey:e,taskId:s},query:a});else if("po60"===t)this.$router.push({name:"po60Intro",params:{studyKey:e,taskId:s},query:a});else if("position"===t)this.$router.push({name:"positionIntro",params:{studyKey:e,taskId:s},query:a});else if("peakFlow"===t)this.$router.push({name:"peakFlowIntro",params:{studyKey:e,taskId:s},query:a});else if("dataQuery"===t)this.$router.push({name:"dataQueryIntro",params:{taskId:s,studyKey:e},query:a});else if("fingerTapping"===t)this.$router.push({name:"fingerTappingIntro",params:{taskId:s,studyKey:e},query:a});else if("tugt"===t)this.$router.push({name:"tugtIntro",params:{taskId:s,studyKey:e},query:a});else if("holdPhone"===t)this.$router.push({name:"holdPhoneIntro",params:{taskId:s,studyKey:e},query:a});else if("vocalization"===t)this.$router.push({name:"vocalizationIntro",params:{taskId:s,studyKey:e},query:a});else{if("drawing"!==t)throw new Error("Could not changeRoute with task type.");this.$router.push({name:"drawingIntro",params:{taskId:s,studyKey:e},query:a})}}},created(){"dataQuery"===this.task.type?(this.title=this.$i18n.t("studies.tasks.dataQuery.shortTitle"),this.main=this.$i18n.t("studies.tasks.dataQuery.shortDescription"),this.icon="insert_chart_outlined"):"form"===this.task.type?(this.title=this.task.formName[this.$root.$i18n.locale],this.main=this.$i18n.t("studies.tasks.form.shortDescription"),this.icon="format_list_bulleted"):"smwt"===this.task.type?(this.title=this.$i18n.t("studies.tasks.smwt.shortTitle"),this.main=this.$i18n.t("studies.tasks.smwt.shortDescription"),this.icon="directions_walk"):"qcst"===this.task.type?(this.title=this.$i18n.t("studies.tasks.qcst.shortTitle"),this.main=this.$i18n.t("studies.tasks.qcst.shortDescription"),this.icon="layers"):"miband3"===this.task.type?(this.title=this.$i18n.t("studies.tasks.miband3.shortTitle"),this.main=this.$i18n.t("studies.tasks.miband3.shortDescription"),this.icon="watch"):"po60"===this.task.type?(this.title=this.$i18n.t("studies.tasks.po60.shortTitle"),this.main=this.$i18n.t("studies.tasks.po60.shortDescription"),this.icon="touch_app"):"position"===this.task.type?(this.title=this.$i18n.t("studies.tasks.position.shortTitle"),this.main=this.$i18n.t("studies.tasks.position.shortDescription"),this.icon="place"):"peakFlow"===this.task.type?(this.title=this.$i18n.t("studies.tasks.peakflow.shortTitle"),this.main=this.$i18n.t("studies.tasks.peakflow.shortDescription"),this.icon="air"):"fingerTapping"===this.task.type?(this.title=this.$i18n.t("studies.tasks.fingerTapping.shortTitle"),this.main=this.$i18n.t("studies.tasks.fingerTapping.shortDescription"),this.icon="touch_app"):"tugt"===this.task.type?(this.title=this.$i18n.t("studies.tasks.tugt.shortTitle"),this.main=this.$i18n.t("studies.tasks.tugt.shortDescription"),this.icon="transfer_within_a_station"):"holdPhone"===this.task.type?(this.title=this.$i18n.t("studies.tasks.holdPhone.shortTitle"),this.main=this.$i18n.t("studies.tasks.holdPhone.shortDescription"),this.icon="svguse:icons/holdphone-icon.svg#holdphone-icon"):"vocalization"===this.task.type?(this.title=this.$i18n.t("studies.tasks.vocalization.shortTitle"),this.main=this.$i18n.t("studies.tasks.vocalization.shortDescription"),this.icon="record_voice_over"):"drawing"===this.task.type&&(this.title=this.$i18n.t("studies.tasks.drawing.shortTitle"),this.main=this.$i18n.t("studies.tasks.drawing.shortDescription"),this.icon="draw"),this.task.customTitle&&this.task.customTitle[this.$i18n.locale]&&(this.title=this.task.customTitle[this.$i18n.locale])},computed:{timeRemaining:function(){let t=this.$i18n.t("studies.tasks.due")+" ",e=(new Date).getTime()-this.task.due.getTime();return e/864e5>0?t+=this.$i18n.tc("studies.tasks.daysAgo",Math.round(e/864e5)):e/36e5>0?t+=this.$i18n.tc("studies.tasks.hoursAgo",Math.round(e/864e5)):e/6e4>0&&(t+=this.$i18n.tc("studies.tasks.minsAgo",Math.round(e/864e5))),t}}}),l=r,d=s("2877"),u=s("66e5"),c=s("4074"),h=s("0016"),m=s("0170"),y=s("eebe"),p=s.n(y),k=Object(d["a"])(l,n,o,!1,null,null,null),f=k.exports;p()(k,"components",{QItem:u["a"],QItemSection:c["a"],QIcon:h["a"],QItemLabel:m["a"]});var g=s("9bf1"),w=s("6a6d"),T=s("c313"),b=s("8847"),v=s("570a"),$=s("3615"),I=s("0967"),_=s("1e59");function q(t){return t?new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())):null}function S(t){return t?new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds()):null}function D(t,e){let s={upcoming:[],missed:[],alwaysOn:[]};for(const i of t)if("accepted"===i.currentStatus){let t=e.find((t=>t._key===i.studyKey));if((new Date).toISOString()>t.generalities.endDate+"T23:59:59"){s.completedStudyAlert={studyTitle:t.generalities.title,studyPart:i};continue}const a=t.tasks.filter((t=>{const e=i.taskItemsConsent.find((e=>e.taskId===t.id));return!!e&&e.consented}));let n=!0;for(const e of a){if("dataQuery"===e.type){if(I["b"].is.ios&&_["a"].isAndroidOnly(e.dataType))continue;if(I["b"].is.android&&_["a"].isIOSOnly(e.dataType))continue}let a=C(e.scheduling,i.acceptedTS,i.taskItemsConsent);if(a)if(e.scheduling.alwaysOn){n=!1;let i={type:e.type,studyKey:t._key,taskId:e.id,alwaysOn:!0};"form"===e.type&&(i.formName=e.formName,i.formKey=e.formKey),e.customTitle&&(i.customTitle=e.customTitle),s.alwaysOn.push(i)}else{let a=new Date,o=new Date;o.setHours(0,0,0,0);let r=new Date;r.setHours(23,59,59,999);let l=new Date(new Date(t.generalities.endDate).getTime()+864e5),d=x(e.scheduling,i,l);if(!d)continue;let u,c,h,m=d.between(q(o),q(l));if(m.length>0&&(n=!1),i.taskItemsConsent){const t=i.taskItemsConsent.find((t=>t.taskId===e.id));t&&t.lastExecuted&&(u=new Date(t.lastExecuted))}u?(c=d.between(q(u),q(o)),c=c.length>0?S(c[c.length-1]):null):c=S(d.before(q(o))),h=u&&u>o?d.between(q(u),q(a)):d.between(q(o),q(a)),h=h.length>0?S(h[0]):null;let y={type:e.type,studyKey:t._key,taskId:e.id};"form"===e.type&&(y.formName=e.formName,y.formKey=e.formKey),e.customTitle&&(y.customTitle=e.customTitle),null!==h?s.upcoming.push(Object.assign({missed:!1,due:h},y)):null!==c&&s.missed.push(Object.assign({missed:!0,due:c},y))}}n&&(s.completedStudyAlert={studyTitle:t.generalities.title,studyPart:i})}return s}function C(t,e,s){if(!e||!t)throw new Error("both arguments must be specified in isAlwaysOnTaskDue");let i,a=new Date;if("consent"===t.startEvent)i=new Date(e),i.setHours(0,0,1);else{if("taskExecution"!==t.startEvent)throw new Error("The only start event recognised is consent");{if(void 0===t.eventTaskId)throw new Error("scheduling with taskExecution event must specify a taskId");let e=s.find((e=>e.taskId===t.eventTaskId));if(!(e&&e.consented&&e.lastExecuted))return!1;i=new Date(e.lastExecuted)}}if(t.startDelaySecs&&(i=new Date(i.getTime()+1e3*t.startDelaySecs)),t.untilSecs){let e=new Date(i.getTime()+1e3*t.untilSecs);if(a>i&&a<e)return!0}else if(a>i)return!0;return!1}function x(t,e,s){let i;if("consent"===t.startEvent)i=new Date(e.acceptedTS),i.setHours(0,0,1);else{if("taskExecution"!==t.startEvent)throw new Error("Start event "+t.startEvent+" not recognsed");{if(void 0===t.eventTaskId)throw new Error("Scheduling with taskExecution event must specify a taskId");let s=e.taskItemsConsent.find((e=>e.taskId===t.eventTaskId));if(!s)throw new Error("Scheduling with taskExecution with unused taskId "+t.eventTaskId);if(!s.lastExecuted)return null;i=new Date(s.lastExecuted)}}t.startDelaySecs&&(i=new Date(i.getTime()+1e3*t.startDelaySecs));let a,n=new Date(s);if(t.untilSecs){let e=new Date(i.getTime()+1e3*t.untilSecs);e<n&&(n=new Date(e))}switch(t.intervalType){case"y":a=v["a"].YEARLY;break;case"m":a=v["a"].MONTHLY;break;case"w":a=v["a"].WEEKLY;break;case"d":a=v["a"].DAILY;break;default:throw new Error("No Frequency Specified")}let o=[];if(t.weekDays)for(let d=0;d<t.weekDays.length;d++)switch(t.weekDays[d]){case"mo":o.push(v["a"].MO);break;case"tu":o.push(v["a"].TU);break;case"we":o.push(v["a"].WE);break;case"th":o.push(v["a"].TH);break;case"fr":o.push(v["a"].FR);break;case"sa":o.push(v["a"].SA);break;case"su":o.push(v["a"].SU);break}let r={};r.dtstart=q(i),r.until=n,r.freq=a,t.interval&&t.interval&&(r.interval=t.interval),t.months&&t.months.length&&(r.bymonth=t.months),t.monthDays&&t.monthDays.length&&(r.bymonthday=t.monthDays),o&&o.length&&(r.byweekday=o),t.hours&&t.hours.length&&(r.byhour=t.hours),t.occurrences&&(r.count=t.occurrences);try{return new v["a"](r)}catch(l){throw console.error("Error while parsing scheduling object",r),console.error("Scheduling information: ",t),console.error("Study part, study end:",e,s),l}}async function K(){return $["a"].cancelAll()}const E=20;async function O(t,e){let s=[],i=[];for(const a of t.tasks){let n;if(e.taskItemsConsent&&(n=e.taskItemsConsent.find((t=>t.taskId===a.id))),n&&!n.consented)continue;if("dataQuery"===a.type){if(I["b"].is.ios&&_["a"].isAndroidOnly(a.dataType))continue;if(I["b"].is.android&&_["a"].isIOSOnly(a.dataType))continue}if(a.scheduling.alwaysOn)continue;let o=x(a.scheduling,e,t.generalities.endDate);if(!o)continue;let r=new Date(new Date(t.generalities.endDate).getTime()+864e5),l=new Date,d=o.between(q(l),q(r));for(let e=0;e<d.length&&e<E;e++){let n=S(d[e]);n.setSeconds(0),n.setMilliseconds(0);let o="";if(t._key){let e=t._key.toString();o+=e.slice(-4)}o+=a.id,o+=e,-1===i.indexOf(n.getTime())&&(i.push(n.getTime()),s.push({id:parseInt(o),title:b["b"].t("studies.scheduling.due"),text:b["b"].t("studies.scheduling.start"),foreground:!0,trigger:{at:n}}))}}await $["a"].schedule(s)}const M=9e5;var Q={name:"TaskerPage",components:{taskListItem:f},data(){return{nostudies:!1,newstudies:!1,reloadTimer:void 0,lastReloadTS:void 0,tasks:{upcoming:[],missed:[],alwaysOn:[],completedStudyAlert:void 0,completedStudyTitle:void 0},completedStudyModal:!1,studiesInfo:[]}},async created(){this.load(),document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&Date.now()-this.lastReloadTS>M&&this.load()})),$["a"].registerNotificationsListener((()=>{this.load()}),this),this.reloadTimer=setInterval((()=>{this.load()}),M)},async beforeDestroy(){this.reloadTimer&&clearInterval(this.reloadTimer)},methods:{refresh(t){this.load(!0).then(t)},filterTask(t,e){return t.studyKey===e._key?t:""},async load(t){this.lastReloadTS=Date.now(),t||this.$q.loading.show();try{let t=await T["a"].renewToken();g["a"].user.token=t,T["a"].setToken(t);try{let t=await T["a"].getNewStudiesKeys();t.length>0?this.newstudies=!0:this.newstudies=!1}catch(e){console.error("Cannot connect to server, but thats OK",e)}await K();try{let t=await T["a"].getProfile(g["a"].user._key);if(!t.studies||0===t.studies.length)return await w["a"].setStudiesParticipation([]),this.$q.loading.hide(),void(this.nostudies=!0);await w["a"].setStudiesParticipation(t.studies)}catch(e){console.error("Cannot connect to server, but thats OK",e)}let s=await w["a"].getStudiesParticipation();if(!s)return this.$q.loading.hide(),void(this.nostudies=!0);let i=[],a=[];this.studiesInfo=[];for(const e of s){let t=await w["a"].getStudyDescription(e.studyKey);t||(t=await T["a"].getStudyDescription(e.studyKey),await w["a"].setStudyDescription(e.studyKey,t)),"accepted"===e.currentStatus&&e.reminders&&await O(t,e),"accepted"===e.currentStatus&&(i.push(e),a.push(t),this.studiesInfo.push(t))}if(0===a.length)return this.$q.loading.hide(),void(this.nostudies=!0);let n=D(i,a);this.tasks=n,n.completedStudyAlert&&(this.completedStudyTitle=n.completedStudyAlert.studyTitle[this.$root.$i18n.locale],this.completedStudyModal=!0),this.$q.loading.hide()}catch(e){console.error(e),this.$q.loading.hide(),this.$q.dialog({title:this.$i18n.t("errors.error"),message:this.$i18n.t("errors.generalError"),color:"warning",ok:this.$i18n.t("common.retry"),preventClose:!0}).onOk((()=>{this.load()}))}},async studyCompleted(){let t=this.tasks.completedStudyAlert.studyPart;t.currentStatus="completed",t.completedTS=new Date;try{await T["a"].updateStudyStatus(g["a"].user._key,t.studyKey,t),delete t.extraItemsConsent,delete t.taskItemsConsent,await w["a"].setStudyParticipation(t),this.load(),this.completedStudyModal=!1}catch(e){console.error("Cannot set the study as completed",e),this.$q.notify({color:"negative",message:this.$i18n.t("errors.connectionError")+": "+e.message,icon:"report_problem"})}}}},A=Q,P=s("9989"),L=s("59d7"),R=s("54e1"),H=s("9c40"),N=s("1c1c"),U=s("24e8"),z=Object(d["a"])(A,i,a,!1,null,null,null);e["default"]=z.exports;p()(z,"components",{QPage:P["a"],QPullToRefresh:L["a"],QBanner:R["a"],QBtn:H["a"],QItemLabel:m["a"],QList:N["a"],QItemSection:c["a"],QItem:u["a"],QIcon:h["a"],QDialog:U["a"]})}}]);