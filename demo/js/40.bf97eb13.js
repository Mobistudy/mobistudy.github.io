(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[40],{b224:function(t,a,e){"use strict";e.r(a);var s=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("q-page",{attrs:{id:"main"}},[e("div",{directives:[{name:"show",rawName:"v-show",value:!t.isDownloading,expression:"!isDownloading"}]},[e("p",{staticClass:"q-pa-md"},[t._v(t._s(t.$t("studies.tasks.miband3.chartsIntro")))]),e("div",{staticClass:"text-center text-h6"},[t._v("\n      "+t._s(t.$t("studies.tasks.miband3.lineChart"))+"\n    ")]),e("div",{staticClass:"q-pa-md"},[e("canvas",{ref:"lineChart",staticStyle:{margin:"0 auto","padding-right":"2rem"},attrs:{height:"320"}}),e("div",{staticClass:"row justify-around"},[e("q-btn",{attrs:{label:"-12 "+t.$t("studies.tasks.miband3.hours"),color:"secondary",disable:t.disableMinus},on:{click:function(a){t.lineChartAdd(-12)}}}),e("q-btn",{attrs:{label:"+12 "+t.$t("studies.tasks.miband3.hours"),color:"secondary",disable:t.disablePlus},on:{click:function(a){t.lineChartAdd(12)}}})],1)]),e("q-separator"),e("div",{staticClass:"text-center text-h6"},[t._v("\n      "+t._s(t.$t("studies.tasks.miband3.pieChart"))+"\n    ")]),e("div",{staticClass:"q-pa-md"},[e("canvas",{ref:"pieChart",attrs:{height:"270"}})]),e("q-separator"),e("div",{staticClass:"q-my-md row justify-around"},[e("q-btn",{attrs:{label:t.$t("common.discard"),flat:"",color:"secondary"},on:{click:function(a){return t.skipSend()}}}),e("q-btn",{attrs:{label:t.$t("common.send"),color:"primary"},on:{click:function(a){return t.sendData()}}})],1)],1),e("q-inner-loading",{attrs:{showing:t.isDownloading}},[e("div",{staticClass:"text-overline"},[t._v(t._s(t.$t("studies.tasks.miband3.dataDownload")))]),e("q-spinner-oval",{attrs:{size:"50px",color:"primary"}})],1),e("q-inner-loading",{attrs:{showing:t.isSending}},[e("div",{staticClass:"text-overline"},[t._v(t._s(t.$t("studies.tasks.miband3.dataSending")))]),e("q-spinner-oval",{attrs:{size:"50px",color:"primary"}})],1)],1)},i=[],n=(e("e6cf"),e("ddb0"),e("e995")),r=e("30ef"),o=e.n(r);function d(t){switch(t){case 1:case 16:return"walk";case 3:return"not_worn";case 6:return"charging";case 80:case 90:case 89:case 91:case 92:case 96:return"sedentary";case 98:case 82:return"running";case 17:return"activity_high";case 106:case 112:case 121:case 122:case 123:return"sleep";default:return"unknown"}}var l=e("6a6d"),c=e("9bf1"),h=e("c313"),u=e("c1df"),p=e.n(u);const b=["#800000","#778000","#118000","#008080","#003780","#080080","#440080","#790080","#800046","#800046"];let m=[],y=30,w={type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},options:{animation:{animateScale:!0}},indexes:[],maxIndex:-1,reset(){this.data.datasets.data=[],this.data.datasets.backgroundColor=[],this.data.labels=[],this.indexes=[],this.maxIndex=-1}};var g={hrs:[],steps:[],intensities:[],labels:[],reset(){this.hrs=[],this.steps=[],this.intensities=[],this.labels=[]}},C={name:"MiBand3DataDownloadPage",props:{studyKey:String,taskId:Number},data(){return{startDate:new Date,deviceInfo:{},isDownloading:!1,lineChart:void 0,currentStartHour:0,currentEndHour:12,disableMinus:!0,disablePlus:!1,isSending:!1}},methods:{async downloadData(){this.isDownloading=!0,m=[],w.reset(),g.reset(),this.startDate=await this.getDateToUseForDownload();try{this.deviceInfo=await n["a"].getDeviceInfo(),await n["a"].getStoredData(this.startDate,this.dataCallback);try{await n["a"].disconnect()}catch(t){console.error("cannot disconnect miband3",t)}if(m.length<y)return await this.storeDownloadDate(this.startDate),void this.$router.push({name:"notEnoughDataPage"});this.createPieChart(),this.renderLineChart(this.currentStartHour,this.currentEndHour),this.isDownloading=!1}catch(t){console.error("cannot download data",t),this.showErrorDialog()}},async storeDownloadDate(t){let a=await l["a"].getStudyParticipationTaskItemConsent(this.studyKey,this.taskId);return a.lastMiband3SampleTS=t,await l["a"].setStudyParticipationTaskItemConsent(this.studyKey,this.taskId,a),a},getLatestDownloadedSampleDate(){return m[m.length-1].date},async getDateToUseForDownload(){let t,a=await l["a"].getStudyParticipationTaskItemConsent(this.studyKey,this.taskId),e=a.lastMiband3SampleTS;if(e)t=new Date(e);else{const a=await l["a"].getTaskDescription(this.studyKey,this.taskId);let e=a.lastExecuted;if(e)t=new Date(e);else{t=p()();let e=a.scheduling.intervalType,s=a.scheduling.interval;"d"===e?t.subtract(s,"days"):"w"===e?t.subtract(s,"weeks"):"m"===e?t.subtract(s,"months"):"y"===e&&t.subtract(s,"years"),t=t.toDate()}}return t},renderLineChart(t,a){g.reset();let e=60*t,s=60*a-1;s>=m.length&&(s=m.length-1);for(let i=e;i<=s;i++){let t=m[i];this.addToLineChart(t.hr,t.intensity,t.steps,t.date)}this.updateLineChartReferences(),this.updatePlusMinusButtons()},showErrorDialog(){this.$q.dialog({title:this.$t("errors.error"),message:this.$t("studies.tasks.miband3.dataDownloadError"),cancel:this.$t("common.cancel"),ok:this.$t("common.retry"),persistent:!0}).onOk((()=>{this.downloadData()})).onCancel((()=>{this.cancelTask()}))},async cancelTask(){try{await n["a"].disconnect()}catch(t){console.error("cannot disconnect miband3",t)}this.$router.push({name:"tasker"})},dataCallback(t){m.push(t)},addToLineChart(t,a,e,s){t>30&&t<210&&g.hrs.push({x:s,y:t}),g.intensities.push({x:s,y:a}),g.steps.push({x:s,y:e}),g.labels.push(s)},createPieChart(){for(const a of m){let t=a.activityType,e=d(t);if(void 0===w.indexes[e]){w.maxIndex++;let t=w.maxIndex;w.indexes[e]=t,w.data.datasets[0].data[t]=1,w.data.datasets[0].backgroundColor[t]=b[t],w.data.labels.push(this.$t("studies.tasks.miband3.activityTypes."+e))}else{let t=w.indexes[e];w.data.datasets[0].data[t]++}}let t=this.$refs.pieChart;new o.a(t,w)},updateLineChartReferences(){this.lineChart.data.datasets[0].data=g.hrs,this.lineChart.data.datasets[1].data=g.intensities,this.lineChart.data.datasets[2].data=g.steps,this.lineChart.data.labels=g.labels,this.lineChart.update()},createActivityLineChart(){let t=this.$refs.lineChart;this.lineChart=new o.a.Scatter(t,{type:"scatter",data:{labels:g.labels,datasets:[{label:this.$t("studies.tasks.miband3.hrs"),data:g.hrs,backgroundColor:"#C74038",borderColor:"#C74038",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.intensities"),data:g.intensities,backgroundColor:"#4038C7",borderColor:"#4038C7",borderWidth:0,pointRadius:1,fill:!1,lineTension:0},{label:this.$t("studies.tasks.miband3.steps"),data:g.steps,backgroundColor:"#38C740",borderColor:"#38C740",borderWidth:0,pointRadius:1,fill:!1,lineTension:0}]},options:{responsive:!0,title:{display:!1},scales:{xAxes:[{type:"time",time:{displayFormats:{quarter:"HH:MM:SS"}},scaleLabel:{display:!0,lineChartLabelstring:"Date"}}],yAxes:[{scaleLabel:{display:!0,lineChartLabelstring:"value"}}]}}}),this.lineChart.update()},lineChartAdd(t){this.currentStartHour+=t,this.currentEndHour+=t,this.renderLineChart(this.currentStartHour,this.currentEndHour),this.updatePlusMinusButtons()},updatePlusMinusButtons(){0===this.currentStartHour?this.disableMinus=!0:this.disableMinus=!1,this.currentEndHour>=m.length/60?this.disablePlus=!0:this.disablePlus=!1},async skipSend(){await this.storeDownloadDate(this.getLatestDownloadedSampleDate());let t=this.studyKey,a=Number(this.taskId);await l["a"].setTaskCompletion(t,a,new Date),this.$router.push({name:"tasker"})},async sendData(){this.isSending=!0,await this.delay(2);try{let t=this.studyKey,a=Number(this.taskId);await h["a"].sendMiBand3Data({userKey:c["a"].user._key,studyKey:t,taskId:a,createdTS:new Date,device:this.deviceInfo,miband3Data:m}),await l["a"].setTaskCompletion(t,a,new Date);let e=await this.storeDownloadDate(this.getLatestDownloadedSampleDate());await h["a"].updateTaskItemConsent(t,a,e),this.isSending=!1,this.$router.push({name:"tasker"})}catch(t){this.isSending=!1,console.error(t),this.$q.notify({color:"negative",message:this.$t("errors.connectionError")+" "+t.message,icon:"report_problem",onDismiss(){this.$router.push({name:"tasker"})}})}},async delay(t){return new Promise(((a,e)=>{setTimeout((()=>{a()}),1e3*t)}))}},async mounted(){this.createActivityLineChart(),await this.downloadData()},async beforeDestroy(){try{await n["a"].disconnect()}catch(t){console.error("cannot disconnect miband3",t)}}},k=C,D=e("2877"),v=e("9989"),f=e("9c40"),S=e("eb85"),x=e("74f7"),$=e("1b41"),T=e("eebe"),I=e.n(T),q=Object(D["a"])(k,s,i,!1,null,null,null);a["default"]=q.exports;I()(q,"components",{QPage:v["a"],QBtn:f["a"],QSeparator:S["a"],QInnerLoading:x["a"],QSpinnerOval:$["a"]})}}]);